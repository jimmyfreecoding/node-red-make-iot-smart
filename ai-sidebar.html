<!--
  Copyright 2024 Zheng He
  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at
  http://www.apache.org/licenses/LICENSE-2.0
  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->


<script type="text/javascript">
    // 全局错误处理器
    console.log("进入AI-Sidebar页面")
    window.addEventListener('error', function(e) {
        console.error('=== 全局JavaScript错误 ===');
        console.error('错误信息:', e.message);
        console.error('错误文件:', e.filename);
        console.error('错误行号:', e.lineno);
        console.error('错误列号:', e.colno);
        console.error('错误对象:', e.error);
        console.error('错误堆栈:', e.error ? e.error.stack : 'no stack');
    });
    
    var currentStreamMessageId = null;
        // 场景管理器 - 移到最前面定义
    var ScenarioManager = {
        currentScenario: 'learning',
        scenarios: {},
        isLoaded: false,
        
        init: function() {
            console.log('初始化场景管理器');
            
            // 从后端加载场景数据
            return this.loadScenarios().then(() => {
                // 绑定场景选择事件
                $("#scenario-selector").on("change", function() {
                    var selectedScenario = $(this).val();
                    ScenarioManager.switchScenario(selectedScenario);
                });
                
                // 初始化默认场景
                this.updateUI();
                
                // 移除欢迎对话框显示
            }).catch(error => {
                console.error('加载场景失败:', error);
                // 使用默认场景数据作为降级方案
                this.scenarios = {
                    learning: {
                        name: '学习',
                        description: '学习Node-RED节点和流程概念',
                        prompt: []
                    }
                };
                this.isLoaded = true;
                this.updateUI();
            });
        },
        
        loadScenarios: function() {
            return new Promise((resolve, reject) => {
                console.log('从后端加载场景数据...');
                
                fetch('/ai-sidebar/scenarios')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('场景数据加载成功:', data);
                        this.scenarios = data;
                        this.isLoaded = true;
                        resolve(data);
                    })
                    .catch(error => {
                        console.error('加载场景数据失败:', error);
                        reject(error);
                    });
            });
        },
        
        // showWelcomeDialog函数已移除
        
        switchScenario: function(scenarioId) {
            console.log('切换场景:', scenarioId);
            
            // 获取实际的场景数据
            var scenarios = this.scenarios.scenarios || this.scenarios;
            console.log('场景数据结构:', scenarios);
            console.log('查找场景ID:', scenarioId);
            
            if (!scenarios[scenarioId]) {
                console.warn('未知场景:', scenarioId);
                console.log('可用场景:', Object.keys(scenarios));
                return;
            }
            
            this.currentScenario = scenarioId;
            this.updateUI();
            
            // 发送场景切换消息（移除自动调用大模型的逻辑）
            var scenario = scenarios[scenarioId];
            console.log('切换到场景:', scenario);
            
            // 构建包含提示词按钮的消息内容
            var messageContent = `🔄 已切换到 ${scenario.name}\n\n${scenario.description}`;
            
            // 如果场景有提示词模板，添加按钮
            if (scenario.prompt && Array.isArray(scenario.prompt) && scenario.prompt.length > 0) {
                messageContent += '\n\n**快速开始：**';
                var promptButtons = scenario.prompt.map(function(prompt) {
                    return `<button class="prompt-template-btn" data-prompt="${prompt.replace(/"/g, '&quot;')}" style="padding: 6px 12px; background: rgb(229, 231, 235); border: none; border-radius: 16px; text-align: center; cursor: pointer; transition: 0.2s; font-size: 11px; line-height: 1.2; color: rgb(55, 65, 81); display: inline-block; margin: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; transform: scale(1);" onmouseover="this.style.background='#d1d5db'; this.style.transform='scale(1.05)';" onmouseout="this.style.background='#e5e7eb'; this.style.transform='scale(1)';" onclick="document.getElementById('augment-chat-input').value='${prompt.replace(/'/g, "\\'")}'">${prompt}</button>`;
                }).join('');
                messageContent += `\n<div class="prompt-template-container">${promptButtons}</div>`;
            }
            
            addMessageToChat('system', messageContent);
            
            // 滚动到底部
            forceScrollToBottom();
        },
        
        updateUI: function() {
            // 获取实际的场景数据结构
            var scenarios = this.scenarios.scenarios || this.scenarios;
            var scenario = scenarios[this.currentScenario];
            
            if (!scenario) {
                console.warn('未找到场景数据:', this.currentScenario);
                console.log('可用场景:', Object.keys(scenarios));
                return;
            }
            
            // 更新输入框占位符
            $("#augment-chat-input").attr('placeholder', `在${scenario.name}下输入您的问题...`);
            
            // 更新选择器值
            $("#scenario-selector").val(this.currentScenario);
            
            // 更新当前场景显示
            $("#current-scenario-name").text(scenario.name);
            
            console.log('UI已更新为场景:', this.currentScenario, '场景名称:', scenario.name);
        },
        
        getCurrentScenario: function() {
            return this.currentScenario;
        }
    };
    // 更新当前flow名称的函数
    function updateCurrentFlowName() {
        try {
            // 获取当前活动的workspace
            var activeWorkspace = RED.workspaces.active();
            
            if (activeWorkspace) {
                // 获取workspace节点
                var workspaceNode = RED.nodes.workspace(activeWorkspace);
                
                if (workspaceNode && workspaceNode.label) {
                    // 更新显示的flow名称
                    $("#current-flow-name").text(workspaceNode.label);
                } else {
                    $("#current-flow-name").text("Flow " + activeWorkspace);
                }
            } else {
                $("#current-flow-name").text("未选择流程");
            }
        } catch (error) {
            console.warn("更新流程名称失败:", error);
            $("#current-flow-name").text("未知流程");
        }
    }

    // 更新当前选中节点信息的函数
    function updateSelectedNodeInfo() {
        try {
            var selection = RED.view.selection();
            
            if (!selection || !selection.nodes || selection.nodes.length === 0) {
                $("#current-selected-node").text("未选择节点");
                $("#selected-node-type-container").hide();
            } else if (selection.nodes.length === 1) {
                var node = selection.nodes[0];
                var nodeInfo = node.name || node.type || "未知节点";
                $("#current-selected-node").text(nodeInfo);
                
                // 显示节点类型
                if (node.type) {
                    $("#current-selected-node-type").text(node.type);
                    $("#selected-node-type-container").show();
                } else {
                    $("#selected-node-type-container").hide();
                }
            } else {
                $("#current-selected-node").text("已选择 " + selection.nodes.length + " 个节点");
                $("#selected-node-type-container").hide();
            }
        } catch (error) {
            console.warn("更新节点信息失败:", error);
            $("#current-selected-node").text("未知节点");
            $("#selected-node-type-container").hide();
        }
    }
    
    function setupAIAssistant() {
        // 自动调整文本区域高度
        $("#augment-chat-input").on("input", function() {
            this.style.height = "auto";
            this.style.height = Math.min(this.scrollHeight, 120) + "px";
        });
        
        // 发送按钮点击事件
        $("#augment-send").on("click", function() {
            sendMessage();
        });
        
        // 按Enter键发送消息（Shift+Enter换行）
        $("#augment-chat-input").on("keydown", function(e) {
            if (e.key === "Enter" && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });
        
        // 工具按钮点击事件
        $("#augment-attach-file").on("click", function() {
            RED.notify("此功能正在开发中", "info");
        });

        // 注意：@按钮的事件绑定移到了侧边栏初始化时进行
    }
    
    // 预处理ACTION_TYPE标记，转换为可执行按钮
    // 预处理：处理ACTION_TYPE标记
    function preprocessActionType(content) {
        console.log('预处理ACTION_TYPE标记');
        
        // 查找ACTION_TYPE和JSON代码块的组合
        const actionPattern = /ACTION_TYPE:\s*(\w+)([\s\S]*?)```json\s*([\s\S]*?)\s*```/gi;
        
        return content.replace(actionPattern, function(match, actionTypeMatch, middleContent, jsonContent) {
            console.log('找到ACTION_TYPE:', actionTypeMatch, 'JSON长度:', jsonContent.length);
            
            // 如果是EXPLAIN类型，不添加按钮标记
            if (actionTypeMatch.toUpperCase() === 'EXPLAIN') {
                return match; // 保持原内容不变
            }
            
            try {
                // 验证JSON格式
                JSON.parse(jsonContent);
                
                // 为非EXPLAIN类型添加动作标记
                var actionId = 'action-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                
                return match + `\n\n<div class="action-marker" data-action-type="${actionTypeMatch.toUpperCase()}" data-json-content="${encodeURIComponent(jsonContent)}" data-action-id="${actionId}" style="display: none;"></div>`;
                
            } catch (e) {
                console.warn('JSON格式无效，跳过处理:', e.message);
                return match;
            }
        });
    }
    function sendMessage() {
        var message = $("#augment-chat-input").val().trim();
        if (message) {
            console.log("发送消息:", message);
            addMessageToChat("user", message);
            
            $("#augment-chat-input").val("");
            $("#augment-chat-input").css("height", "72px");
            
            // 发送到AI后台
            sendToAI(message, false); // 明确指定不是静默发送
        }
    }

    function sendToAI(message, silent = false) {
        var nodeId = getSelectedConfigNodeId();
        if (!nodeId) {
            if (!silent) {
                addMessageToChat("error", "❌ 未找到配置节点，请先创建并配置API密钥");
            }
            return;
        }

        // 检查节点是否已部署
        var configNode = RED.nodes.node(nodeId);
        if (!configNode) {
            if (!silent) {
                addMessageToChat("error", "❌ 配置节点未部署，请点击部署按钮后重试");
            }
            return;
        }

        // 检查是否有未部署的更改
        if (RED.nodes.dirty()) {
            if (!silent) {
                addMessageToChat("warning", "⚠️ 检测到未部署的更改，请先点击部署按钮");
            }
            return;
        }

        // 获取当前场景
        var currentScenario = ScenarioManager.getCurrentScenario();
        console.log('当前场景:', currentScenario);

        // 获取当前选中的流程和节点信息
        var selectedFlow = null;
        var selectedNodes = [];
        var flowData = null;

        try {
            // 获取当前活动的工作区
            var activeWorkspace = RED.workspaces.active();
            if (activeWorkspace) {
                var workspaceObj = RED.nodes.workspace(activeWorkspace);
                if (workspaceObj) {
                    selectedFlow = {
                        id: workspaceObj.id,
                        label: workspaceObj.label || 'Untitled Flow'
                    };
                }
            }
            
            // 获取选中的节点
            var selection = RED.view.selection();
            if (selection && selection.nodes) {
                selectedNodes = selection.nodes.map(node => ({
                    id: node.id,
                    type: node.type,
                    name: node.name || '',
                    x: node.x,
                    y: node.y,
                    wires: node.wires || [],
                    config: Object.keys(node).reduce((config, key) => {
                        if (!['credentials', 'apiKey', 'password', 'token'].includes(key) && 
                            !key.startsWith('_') && 
                            typeof node[key] !== 'function') {
                            config[key] = node[key];
                        }
                        return config;
                    }, {})
                }));
                console.log("选中节点数量:", selectedNodes.length);
            }
        } catch (error) {
            console.warn("获取选中信息失败:", error);
        }

        // 构建发送的消息，如果是空消息则发送场景初始化请求
        var sendMessage = message.trim();
        if (!sendMessage) {
            var scenario = ScenarioManager.scenarios[currentScenario];
            sendMessage = `请为${scenario.name}场景提供初始指导信息和建议。`;
        }

        // 检测"当前流程"相关提示词（所有场景）
        var dynamicData = {};
        if (sendMessage.includes('当前流程') || sendMessage.includes('current flow')) {
            
            // 如果有选中的流程，传递流程ID给get-flow工具
            if (selectedFlow && selectedFlow.id) {
                dynamicData.flowId = selectedFlow.id;
                console.log('检测到流程解释请求，传递流程ID:', selectedFlow.id);
                
                // 修改消息以包含工具调用指示
                sendMessage = `请使用get-flow工具获取流程ID为"${selectedFlow.id}"的流程数据，然后分析和解释这个流程的功能、节点连接关系和工作原理。\n\n用户原始请求：${sendMessage}`;
            } else {
                // 没有选中流程时的提示
                sendMessage = `${sendMessage}\n\n注意：当前没有选中具体的流程，请先在Node-RED编辑器中选择要分析的流程标签页。`;
            }
        }
        
        // 检测"当前节点"相关提示词（所有场景）
        if (sendMessage.includes('当前节点') || sendMessage.includes('current node')) {
            
            // 如果有选中的节点，传递节点信息给get-node-info工具
            if (selectedNodes && selectedNodes.length > 0) {
                dynamicData.selectedNodes = selectedNodes;
                console.log('检测到节点解释请求，传递选中节点:', selectedNodes.map(n => ({ id: n.id, type: n.type, name: n.name })));
                
                // 修改消息以包含工具调用指示
                const nodeDescription = selectedNodes.length === 1 
                    ? `节点"${selectedNodes[0].name || selectedNodes[0].type}"(类型: ${selectedNodes[0].type})`
                    : `${selectedNodes.length}个选中节点`;
                    
                sendMessage = `请使用get-node-info工具获取选中节点的详细信息，然后分析和解释${nodeDescription}的功能、配置和作用。\n\n用户原始请求：${sendMessage}`;
            } else {
                // 没有选中节点时的提示
                sendMessage = `${sendMessage}\n\n注意：当前没有选中具体的节点，请先在Node-RED编辑器中选择要分析的节点。`;
            }
        }
        
        // 检测"当前配置"相关提示词（所有场景）
        if (sendMessage.includes('当前配置') || sendMessage.includes('current config') || sendMessage.includes('current settings')) {
            console.log('检测到配置分析请求');
            
            // 自动切换到配置场景，因为get-settings工具只在配置场景中可用
            if (currentScenario !== 'configuration') {
                console.log('自动切换到配置场景以使用get-settings工具');
                currentScenario = 'configuration';
                ScenarioManager.currentScenario = 'configuration';
                ScenarioManager.updateUI();
            }
            
            // 修改消息以包含工具调用指示（注意：MCP工具名中的连字符会被转换为下划线）
            sendMessage = `请使用get_settings工具获取当前Node-RED的配置信息，然后分析和解释配置文件的各项设置、功能和作用。\n\n用户原始请求：${sendMessage}`;
        }

        console.log("发送AI请求:", {
            message: sendMessage,
            scenario: currentScenario,
            nodeId: nodeId,
            selectedFlow: selectedFlow,
            selectedNodes: selectedNodes,
            silent: silent
        });
        
        // 创建加载消息
        var loadingMessageId = "loading-" + Date.now();
        var aiMessageId = "ai-" + Date.now();
        addMessageToChat("assistant", "🤖 思考中...", loadingMessageId);
        
        // 异步获取聊天历史后发送请求
        getChatHistory(function(history) {
            console.log('🚀 准备发送流式聊天请求到:', '/ai-sidebar/stream-chat');
            fetch('/ai-sidebar/stream-chat', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json; charset=utf-8',
                },
                body: JSON.stringify({
                    message: sendMessage,
                    scenario: currentScenario,  // 添加场景信息
                    sessionId: getCurrentSessionId(),  // 添加会话ID
                    nodeId: nodeId,
                    selectedFlow: selectedFlow,
                    selectedNodes: selectedNodes,
                    flowData: flowData,
                    history: history,  // 使用异步获取的历史记录
                    silent: silent,  // 添加静默标记
                    dynamicData: dynamicData  // 添加动态数据
                })
            })
        .then(response => {
            console.log('✅ 收到流式聊天响应:', response.status, response.statusText);
            if (!response.ok) {
                console.error('❌ HTTP错误:', response.status, response.statusText);
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const reader = response.body.getReader();
            const decoder = new TextDecoder('utf-8');
            
            function readStream() {
                return reader.read().then(({ done, value }) => {
                    if (done) {
                        console.log('流式响应完成');
                        return;
                    }
                    
                    const chunk = decoder.decode(value);
                    console.log('收到数据块:', chunk);
                    const lines = chunk.split('\n');
                    console.log('分割后的行数:', lines.length);
                    
                    for (const line of lines) {
                        console.log('处理行:', line);
                        if (line.startsWith('data: ')) {
                            try {
                                const jsonStr = line.slice(6);
                                console.log('解析JSON:', jsonStr);
                                const data = JSON.parse(jsonStr);
                                console.log('解析后的数据:', data);
                                handleStreamData(data, loadingMessageId);
                            } catch (e) {
                                console.warn('解析SSE数据失败:', e, line);
                            }
                        }
                    }
                    
                    return readStream();
                });
            }
            
            return readStream();
        })
        .catch(error => {
            console.error('🔥 流式聊天请求失败:', error);
            console.error('🔥 错误详情:', error.message, error.stack);
            $("#" + loadingMessageId).remove();
            
            var errorMessage = "❌ AI请求失败: " + error.message;
            addMessageToChat("error", errorMessage);
            
            // 检查是否是网络或认证相关错误，显示RED.notify通知
            if (error.message.includes('401') || error.message.includes('403') || 
                error.message.includes('Unauthorized') || error.message.includes('API key')) {
                RED.notify('API密钥认证失败，请检查配置节点中的API密钥是否正确', 'error');
            } else {
                RED.notify('AI服务连接失败，请检查网络连接和配置', 'error');
            }
        });
        }); // 结束getChatHistory回调函数
    }

    function handleStreamData(data, loadingMessageId) {
        switch (data.type) {
            case 'start':
                // 移除加载消息，开始显示实际响应
                $("#" + loadingMessageId).remove();
                currentStreamMessageId = 'stream-' + Date.now();
                addMessageToChat("assistant", "", currentStreamMessageId);
                break;
                
            case 'text':
            case 'content':
                // 追加文本内容
                if (currentStreamMessageId) {
                    appendToMessage(currentStreamMessageId, data.content);
                }
                break;
                
            case 'text-delta':
                // 处理流式文本增量
                if (currentStreamMessageId) {
                    appendToMessage(currentStreamMessageId, data.textDelta);
                }
                break;
                
            case 'action_button':
                // 处理动作按钮
                if (currentStreamMessageId) {
                    addActionButton(currentStreamMessageId, data);
                }
                break;
                
            case 'tool_call':
                // 显示工具调用信息
                if (currentStreamMessageId) {
                    var toolInfo = `🔧 调用工具: ${data.tool_name}\n参数: ${JSON.stringify(data.arguments, null, 2)}\n`;
                    appendToMessage(currentStreamMessageId, toolInfo);
                }
                break;
                
            case 'tool_result':
                // 显示简洁的工具执行成功信息
                if (currentStreamMessageId) {
                    var resultInfo = `✅ 工具执行成功\n\n`;
                    appendToMessage(currentStreamMessageId, resultInfo);
                }
                break;
                
            case 'error':
                if (currentStreamMessageId) {
                    appendToMessage(currentStreamMessageId, `❌ 错误: ${data.message || data.content || data.error}`);
                }
                
                // 显示RED.notify通知
                RED.notify(data.message || data.content || data.error || '发生未知错误', 'error');
                break;
                
            case 'done':
            case 'end':
            case 'finish':
                // 流式响应完成，最后检测一次动作标记
                if (currentStreamMessageId) {
                    detectAndProcessActionMarkers(currentStreamMessageId);
                    // 保存完整的聊天消息
                    var messageElement = $("#" + currentStreamMessageId + " .message-content");
                    var finalContent = messageElement.attr('data-raw-text') || messageElement.text() || "";
                    saveChatMessage("assistant", finalContent);
                }
                currentStreamMessageId = null;
                break;
        }
    }

    function appendToMessage(messageId, content) {
        var messageElement = $("#" + messageId + " .message-content");
        if (messageElement.length > 0) {
            // Get current text content (not HTML to avoid double-rendering)
            var currentText = messageElement.attr('data-raw-text') || '';
            var newText = currentText + content;
            
            // Store raw text for future appends
            messageElement.attr('data-raw-text', newText);
            
            // Render combined content as markdown
            var renderedContent = renderMarkdown(newText);
            
            messageElement.html(renderedContent);
            
            // Apply syntax highlighting if highlight.js is available
            if (typeof hljs !== 'undefined') {
                messageElement.find('pre code').each(function(i, block) {
                    try {
                        hljs.highlightElement(block);
                    } catch (e) {
                        console.warn('语法高亮失败:', e);
                    }
                });
            }
            
            // 增强代码块显示 - 确保在语法高亮后执行
            setTimeout(function() {
                enhanceCodeBlocks(messageElement);
            }, 100);
            
            // 滚动到底部
            forceScrollToBottom();
        }
    }

    function getSelectedConfigNodeId() {
        // 首先查找AI助手节点，然后获取其关联的API配置节点
        var configNodeId = null;
        try {
            // 查找make-iot-smart类型的AI助手节点
            RED.nodes.eachNode(function(node) {
                if (node.type === 'make-iot-smart' && node.apiConfig) {
                    configNodeId = node.apiConfig;
                    console.log("通过AI助手节点找到api-config:", configNodeId, node);
                    return false; // 找到第一个就停止
                }
            });
            
            // 如果没有通过AI助手节点找到，直接查找api-config节点
            if (!configNodeId) {
                RED.nodes.eachConfig(function(configNode) {
                    if (configNode.type === 'api-config') {
                        configNodeId = configNode.id;
                        console.log("直接找到api-config节点:", configNodeId, configNode);
                        return false; // 找到第一个就停止
                    }
                });
            }
            
            // 如果没有找到，尝试创建一个默认的配置节点
            if (!configNodeId) {
                console.log("未找到api-config节点，尝试创建默认节点");
                configNodeId = createDefaultApiConfigNode();
            }
            
            // 验证节点是否真的存在
            if (configNodeId) {
                var node = RED.nodes.node(configNodeId);
                if (!node) {
                    console.warn("节点ID存在但无法获取节点实例:", configNodeId);
                    return null;
                }
            }
            
        } catch (error) {
            console.warn("获取配置节点失败:", error);
        }
        return configNodeId;
    }
    // 从代码块中获取JSON数据
    function getJsonFromCodeBlock(blockId) {
        try {
            var $codeBlock = $('#' + blockId);
            if (!$codeBlock.length) {
                console.error('未找到代码块:', blockId);
                return null;
            }
            
            // 查找代码块中的code元素
            var $code = $codeBlock.find('code');
            if (!$code.length) {
                console.error('代码块中未找到code元素:', blockId);
                return null;
            }
            
            // 获取代码文本内容
            var codeText = $code.text().trim();
            
            // 尝试解析JSON
            var parsedJson = JSON.parse(codeText);
            return {
                jsonString: codeText,
                parsedJson: parsedJson
            };
            
        } catch (e) {
            console.error('从代码块获取JSON失败:', e, 'blockId:', blockId);
            return null;
        }
    }


    // 降级复制方案
    function fallbackCopyTextToClipboard(text) {
        var textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        textArea.style.left = "-999999px";
        textArea.style.top = "-999999px";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            var successful = document.execCommand('copy');
            if (successful) {
                RED.notify("JSON数据已复制到剪贴板", "success");
            } else {
                RED.notify("复制失败，请手动复制", "error");
            }
        } catch (err) {
            console.error('降级复制失败:', err);
            RED.notify("复制失败，请手动复制", "error");
        }
        
        document.body.removeChild(textArea);
    }


    // 检测和处理动作标记 - 支持ACTION_TYPE格式
    function detectAndProcessActionMarkers(messageId) {
        console.log("=== 检测动作标记 ===");
        console.log("消息ID:", messageId);
        
        var messageElement = $("#" + messageId + " .message-content");
        if (messageElement.length === 0) {
            console.log("消息元素未找到:", messageId);
            return;
        }
        
        // 先尝试增强代码块
        enhanceCodeBlocks(messageElement);
        
        // 检查是否已经添加过按钮
        if (messageElement.find('.action-button-container').length > 0) {
            console.log("按钮已存在，跳过重复添加");
            return;
        }
        
        // 查找动作标记
        var actionMarkers = messageElement.find('.action-marker');
        if (actionMarkers.length > 0) {
            console.log("找到动作标记:", actionMarkers.length, "个");
            
            // 处理第一个动作标记
            var firstMarker = actionMarkers.first();
            var markerActionType = firstMarker.data('action-type');
            var jsonContent = decodeURIComponent(firstMarker.data('json-content') || '');
            
            console.log("处理动作标记:", markerActionType, "JSON长度:", jsonContent.length);
            
            if (markerActionType && jsonContent && markerActionType !== 'EXPLAIN') {
                try {
                    var parsedJson = JSON.parse(jsonContent);
                    
                    var actionData = {
                        type: 'action_button',
                        actionType: markerActionType,
                        toolName: getToolNameForAction(markerActionType),
                        toolArgs: buildToolArgsForAction(markerActionType, parsedJson),
                        jsonContent: JSON.stringify(parsedJson, null, 2),
                        buttonText: getButtonTextForAction(markerActionType),
                        buttonColor: getButtonColorForAction(markerActionType),
                        buttonIcon: getButtonIconForAction(markerActionType),
                        description: getDescriptionForAction(markerActionType)
                    };
                    
                    console.log("构建动作数据成功:", {
                        actionType: actionData.actionType,
                        toolName: actionData.toolName,
                        buttonText: actionData.buttonText
                    });
                    
                    // 添加动作按钮
                    addActionButton(messageId, actionData);
                    
                } catch (error) {
                    console.error("处理动作失败:", error);
                }
            }
            return;
        }
        
        // 如果没有找到动作标记，使用原有的文本解析方式
        var rawText = messageElement.attr('data-raw-text') || '';
        console.log("使用文本解析方式，文本长度:", rawText.length);
        
        // 检测ACTION_TYPE格式
        var actionTypePattern = /ACTION_TYPE:\s*(\w+)/gi;
        var jsonBlockPattern = /```json\s*([\s\S]*?)\s*```/gi;
        
        var detectedActionType = null;
        var detectedJsonContent = null;
        
        // 查找ACTION_TYPE
        actionTypePattern.lastIndex = 0;
        var actionMatch = actionTypePattern.exec(rawText);
        if (actionMatch) {
            detectedActionType = actionMatch[1].toUpperCase();
            console.log("检测到动作类型:", detectedActionType);
        }
        
        // 查找JSON配置
        jsonBlockPattern.lastIndex = 0;
        var jsonMatch = jsonBlockPattern.exec(rawText);
        if (jsonMatch) {
            detectedJsonContent = jsonMatch[1].trim();
            console.log("找到JSON配置:", detectedJsonContent.substring(0, 200));
        }
        
        // 只有在有JSON配置且不是EXPLAIN类型时才添加按钮
        if (detectedActionType && detectedJsonContent && detectedActionType !== 'EXPLAIN') {
            try {
                var parsedJson = JSON.parse(detectedJsonContent);
                
                var actionData = {
                    type: 'action_button',
                    actionType: detectedActionType,
                    toolName: getToolNameForAction(detectedActionType),
                    toolArgs: buildToolArgsForAction(detectedActionType, parsedJson),
                    jsonContent: JSON.stringify(parsedJson, null, 2),
                    buttonText: getButtonTextForAction(detectedActionType),
                    buttonColor: getButtonColorForAction(detectedActionType),
                    buttonIcon: getButtonIconForAction(detectedActionType),
                    description: getDescriptionForAction(detectedActionType)
                };
                
                console.log("构建动作数据成功:", {
                    actionType: actionData.actionType,
                    toolName: actionData.toolName,
                    buttonText: actionData.buttonText
                });
                
                // 添加动作按钮
                addActionButton(messageId, actionData);
                
            } catch (error) {
                console.error("处理动作失败:", error);
            }
        } else if (detectedActionType === 'EXPLAIN') {
            // 对于EXPLAIN类型，不需要添加按钮，只是说明性内容
            console.log("检测到EXPLAIN类型，无需添加按钮");
        } else {
            console.log("未检测到完整的动作配置或为纯说明内容");
        }
    }

    // 预处理Node-RED流程JSON中的function节点代码
    function preprocessNodeRedFunctionCode(content) {
        console.log('预处理Node-RED function代码');
        
        // 查找JSON代码块
        const jsonBlockPattern = /```json\s*([\s\S]*?)\s*```/g;
        
        return content.replace(jsonBlockPattern, function(match, jsonContent) {
            try {
                console.log('处理JSON代码块');
                
                // 尝试解析JSON
                const parsedJson = JSON.parse(jsonContent);
                
                // 如果是Node-RED流程配置
                if (parsedJson.nodes && Array.isArray(parsedJson.nodes)) {
                    console.log('检测到Node-RED流程配置，处理function节点');
                    
                    // 处理每个节点
                    parsedJson.nodes = parsedJson.nodes.map(function(node, index) {
                        if (node.type === 'function' && node.func && typeof node.func === 'string') {
                            console.log('处理function节点: ' + (node.name || node.id));
                            
                            // 生成唯一ID
                            const codeId = 'func-code-' + Date.now() + '-' + index;
                            
                            // 保存原始代码到全局变量
                            if (!window.nodeRedFunctionCodes) {
                                window.nodeRedFunctionCodes = {};
                            }
                            window.nodeRedFunctionCodes[codeId] = {
                                code: node.func,
                                nodeName: node.name || node.id,
                                nodeId: node.id
                            };
                            
                            // 替换func内容为简单文本和按钮
                            node.func = 'code <button class="code-view-btn" data-code-id="' + codeId + '" style="' +
                                'background: #f1f5f9; ' +
                                'border: 1px solid #cbd5e1; ' +
                                'border-radius: 4px; ' +
                                'padding: 2px 8px; ' +
                                'font-size: 12px; ' +
                                'color: #475569; ' +
                                'cursor: pointer; ' +
                                'margin-left: 4px; ' +
                                'vertical-align: middle; ' +
                                'transition: all 0.2s;' +
                                '">查看代码</button>';
                        }
                        return node;
                    });
                    
                    // 返回处理后的JSON代码块
                    return '```json\n' + JSON.stringify(parsedJson, null, 2) + '\n```';
                }
                
                // 如果不是Node-RED流程配置，返回原内容
                return match;
                
            } catch (e) {
                console.warn('JSON解析失败，跳过处理:', e.message);
                return match;
            }
        });
    }

    // 显示function代码的模态框
    function showFunctionCodeModal(codeData) {
        console.log('显示function代码:', codeData.nodeName);
        
        // 转义节点名称以防止HTML注入
        var escapedNodeName = codeData.nodeName.replace(/[<>&"']/g, function(match) {
            var escapeMap = {
                '<': '&lt;',
                '>': '&gt;',
                '&': '&amp;',
                '"': '&quot;',
                "'": '&#39;'
            };
            return escapeMap[match];
        });
        
        var escapedCode = codeData.code.replace(/[<>&"']/g, function(match) {
            var escapeMap = {
                '<': '&lt;',
                '>': '&gt;',
                '&': '&amp;',
                '"': '&quot;',
                "'": '&#39;'
            };
            return escapeMap[match];
        });
        
        // 创建模态框HTML
        var modalHtml = '<div id="function-code-modal" style="' +
            'position: fixed;' +
            'top: 0;' +
            'left: 0;' +
            'width: 100%;' +
            'height: 100%;' +
            'background: rgba(0,0,0,0.5);' +
            'z-index: 10000;' +
            'display: flex;' +
            'align-items: center;' +
            'justify-content: center;' +
            '">' +
                '<div style="' +
                    'background: white;' +
                    'border-radius: 8px;' +
                    'width: 80%;' +
                    'max-width: 800px;' +
                    'max-height: 80%;' +
                    'display: flex;' +
                    'flex-direction: column;' +
                    'box-shadow: 0 4px 20px rgba(0,0,0,0.3);' +
                    '">' +
                    '<div style="' +
                        'padding: 16px 20px;' +
                        'border-bottom: 1px solid #e5e7eb;' +
                        'display: flex;' +
                        'justify-content: space-between;' +
                        'align-items: center;' +
                        '">' +
                        '<h3 style="margin: 0; color: #374151;">Function节点代码: ' + escapedNodeName + '</h3>' +
                        '<button id="close-code-modal" style="' +
                            'background: none;' +
                            'border: none;' +
                            'font-size: 20px;' +
                            'cursor: pointer;' +
                            'color: #6b7280;' +
                            '">&times;</button>' +
                    '</div>' +
                    '<div style="' +
                        'flex: 1;' +
                        'overflow: auto;' +
                        'padding: 20px;' +
                        '">' +
                        '<pre style="' +
                            'background: #f8fafc;' +
                            'border: 1px solid #e2e8f0;' +
                            'border-radius: 6px;' +
                            'padding: 16px;' +
                            'margin: 0;' +
                            'overflow: auto;' +
                            'font-family: Monaco, Menlo, Ubuntu Mono, monospace;' +
                            'font-size: 14px;' +
                            'line-height: 1.5;' +
                            '"><code class="javascript">' + escapedCode + '</code></pre>' +
                    '</div>' +
                    '<div style="' +
                        'padding: 16px 20px;' +
                        'border-top: 1px solid #e5e7eb;' +
                        'display: flex;' +
                        'justify-content: flex-end;' +
                        'gap: 10px;' +
                        '">' +
                        '<button id="copy-code-btn" style="' +
                            'background: #3b82f6;' +
                            'color: white;' +
                            'border: none;' +
                            'padding: 8px 16px;' +
                            'border-radius: 6px;' +
                            'cursor: pointer;' +
                            '">复制代码</button>' +
                        '<button id="close-code-modal-btn" style="' +
                            'background: #6b7280;' +
                            'color: white;' +
                            'border: none;' +
                            'padding: 8px 16px;' +
                            'border-radius: 6px;' +
                            'cursor: pointer;' +
                            '">关闭</button>' +
                    '</div>' +
                '</div>' +
            '</div>';
        
        // 添加到页面
        $('body').append(modalHtml);
        
        // 应用语法高亮
        if (typeof hljs !== 'undefined') {
            $('#function-code-modal code.javascript').each(function(i, block) {
                try {
                    hljs.highlightElement(block);
                } catch (e) {
                    console.warn('语法高亮失败:', e);
                }
            });
        }
        
        // 绑定关闭事件
        $('#close-code-modal, #close-code-modal-btn').click(function() {
            $('#function-code-modal').remove();
        });
        
        // 绑定复制事件
        $('#copy-code-btn').click(function() {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(codeData.code).then(function() {
                    $('#copy-code-btn').text('已复制').css('background', '#10b981');
                    setTimeout(function() {
                        $('#copy-code-btn').text('复制代码').css('background', '#3b82f6');
                    }, 2000);
                }).catch(function(err) {
                    console.error('复制失败:', err);
                });
            } else {
                // 降级方案
                var textArea = document.createElement("textarea");
                textArea.value = codeData.code;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    $('#copy-code-btn').text('已复制').css('background', '#10b981');
                    setTimeout(function() {
                        $('#copy-code-btn').text('复制代码').css('background', '#3b82f6');
                    }, 2000);
                } catch (err) {
                    console.error('复制失败:', err);
                }
                document.body.removeChild(textArea);
            }
        });
        
        // 点击背景关闭
        $('#function-code-modal').click(function(e) {
            if (e.target === this) {
                $(this).remove();
            }
        });
    }
    // 添加更多选项按钮的下拉菜单事件处理
    $(document).on('click', '.code-more-btn', function(e) {
        e.preventDefault();
        e.stopPropagation();
        
        var blockId = $(this).data('block-id');
        var $button = $(this);
        var existingMenu = $('.code-dropdown-menu');
        
        // 如果已有菜单，先移除
        if (existingMenu.length > 0) {
            existingMenu.remove();
            return;
        }
        
        // 获取当前流程信息
        var currentFlowName = '未选择流程';
        try {
            var activeWorkspace = RED.workspaces.active();
            if (activeWorkspace) {
                var workspace = RED.nodes.workspace(activeWorkspace);
                currentFlowName = workspace ? workspace.label : '当前流程';
            }
        } catch (error) {
            console.warn("获取当前流程失败:", error);
        }
        
        // 添加CSS重置样式来确保菜单项没有默认间距
        if (!document.getElementById('code-dropdown-reset-styles')) {
            var resetStyle = document.createElement('style');
            resetStyle.id = 'code-dropdown-reset-styles';
            resetStyle.textContent = `
                .code-dropdown-menu {
                    box-sizing: border-box !important;
                }
                .code-dropdown-menu .menu-item {
                    margin: 0 !important;
                    padding: 0px 16px !important;
                    border: none !important;
                    line-height: 1 !important;
                    height: 0px !important;
                    box-sizing: border-box !important;
                    display: flex !important;
                    align-items: center !important;
                }
                .code-dropdown-menu .menu-item:first-child {
                    border-top-left-radius: 6px;
                    border-top-right-radius: 6px;
                }
                .code-dropdown-menu .menu-item:last-child {
                    border-bottom-left-radius: 6px;
                    border-bottom-right-radius: 6px;
                }
            `;
            document.head.appendChild(resetStyle);
        }
        
        // 创建下拉菜单
        var menuHtml = `
            <div class="code-dropdown-menu" style="
                position: absolute;
                top: 100%;
                right: 0;
                background: white;
                border: 1px solid #d1d5db;
                border-radius: 6px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                min-width: 140px;
                font-size: 13px;
                padding: 0;
                margin-top: 4px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                line-height: 1;
            ">
                <div class="menu-item" data-action="copy" data-block-id="${blockId}" style="
                    padding: 10px 16px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    color: #374151;
                    transition: background-color 0.1s;
                    font-weight: 400;
                    margin: 0;
                    border: none;
                    line-height: 1;
                    height: 36px;
                    box-sizing: border-box;
                " onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'">
                    <i class="fa fa-copy" style="font-size: 12px; width: 14px; color: #6b7280;"></i>
                    <span>Copy</span>
                </div>
                <div class="menu-item" data-action="create-new" data-block-id="${blockId}" style="
                    padding: 10px 16px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    color: #374151;
                    transition: background-color 0.1s;
                    font-weight: 400;
                    margin: 0;
                    border: none;
                    line-height: 1;
                    height: 36px;
                    box-sizing: border-box;
                " onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'">
                    <i class="fa fa-plus" style="font-size: 12px; width: 14px; color: #6b7280;"></i>
                    <span>在新流程中创建</span>
                </div>
                <div class="menu-item" data-action="create-current" data-block-id="${blockId}" style="
                    padding: 10px 16px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    color: #374151;
                    transition: background-color 0.1s;
                    font-weight: 400;
                    margin: 0;
                    border: none;
                    line-height: 1;
                    height: 36px;
                    box-sizing: border-box;
                " onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'">
                    <i class="fa fa-edit" style="font-size: 12px; width: 14px; color: #6b7280;"></i>
                    <span>在${currentFlowName}中创建</span>
                </div>
            </div>
        `;
        
        // 将菜单添加到按钮的父容器中
        $button.parent().append(menuHtml);
        
        // 点击其他地方关闭菜单
        $(document).on('click.code-dropdown', function(e) {
            if (!$(e.target).closest('.code-dropdown-menu, .code-more-btn').length) {
                $('.code-dropdown-menu').remove();
                $(document).off('click.code-dropdown');
            }
        });
    });
    // 处理下拉菜单项点击
    $(document).on('click', '.menu-item', function(e) {
        e.preventDefault();
        
        var action = $(this).data('action');
        var blockId = $(this).data('block-id');
        
        console.log('菜单项点击:', action, blockId);
        
        // 关闭菜单
        $('.code-dropdown-menu').remove();
        $(document).off('click.code-dropdown');
        
        // 从代码块中获取JSON数据
        var jsonData = getJsonFromCodeBlock(blockId);
        if (!jsonData) {
            RED.notify("无法获取JSON数据", "error");
            return;
        }
        
        // 处理复制操作
        if (action === 'copy') {
            try {
                var formattedJson = JSON.stringify(jsonData.parsedJson, null, 2);
                
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(formattedJson).then(function() {
                        RED.notify("JSON数据已复制到剪贴板", "success");
                    }).catch(function(err) {
                        console.error('复制失败:', err);
                        fallbackCopyTextToClipboard(formattedJson);
                    });
                } else {
                    fallbackCopyTextToClipboard(formattedJson);
                }
            } catch (e) {
                RED.notify("JSON格式错误，无法复制", "error");
            }
            return;
        }
        
        // 处理创建操作
        if (action === 'create-new' || action === 'create-current') {
            // 获取当前选中的流程信息
            var selectedFlow = null;
            var nodeId = null;
            
            try {
                // 获取配置节点ID
                var configNodes = [];
                RED.nodes.eachConfig(function(configNode) {
                    if (configNode.type === 'api-config') {
                        configNodes.push(configNode);
                    }
                });
                
                if (configNodes.length > 0) {
                    nodeId = configNodes[0].id;
                }
                
                // 获取当前流程信息
                if (action === 'create-current') {
                    var activeWorkspace = RED.workspaces.active();
                    if (activeWorkspace) {
                        selectedFlow = {
                            id: activeWorkspace,
                            label: RED.nodes.workspace(activeWorkspace).label || '当前流程'
                        };
                    }
                }
            } catch (error) {
                console.warn("获取流程信息失败:", error);
            }
            
            if (!nodeId) {
                RED.notify("未找到API配置节点", "error");
                return;
            }
            
            // 构建工具参数
            var toolArgs = {
                flowJson: jsonData.jsonString, // 使用原始JSON字符串
                description: jsonData.parsedJson.description || ''
            };
            
            // 根据操作类型设置标签
            if (action === 'create-current' && selectedFlow && selectedFlow.id) {
                // 在当前流程中创建时，不设置标签，让后端保持原有标签
                toolArgs.flowId = selectedFlow.id;
                // 只有当JSON中明确指定了标签时才使用
                if (jsonData.parsedJson.label) {
                    toolArgs.label = jsonData.parsedJson.label;
                }
            } else {
                // 创建新流程时使用默认标签
                toolArgs.label = jsonData.parsedJson.label || '新流程';
            }
            
            console.log('执行create-flow工具:', toolArgs);
            
            // 显示执行中的消息
            var executingMsg = action === 'create-new' ? 
                "🔄 正在创建新流程..." : 
                "🔄 正在添加到当前流程...";
            addMessageToChat("system", executingMsg);
            
            // 调用MCP工具
            fetch('/ai-sidebar/execute-tool', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    toolName: 'create-flow',
                    toolArgs: toolArgs,
                    nodeId: nodeId,
                    selectedFlow: selectedFlow
                })
            })
            .then(response => response.json())
            .then(data => {
                console.log('工具执行结果:', data);
                
                if (data.success) {
                    // 显示成功消息
                    var successMsg = action === 'create-new' ? 
                        "✅ 新流程创建成功！" : 
                        "✅ 流程已添加到当前工作区！";
                    addMessageToChat("system", successMsg);
                    
                    // 刷新视图
                    if (typeof RED !== 'undefined' && RED.view) {
                        RED.view.redraw();
                    }
                } else {
                    // 执行失败
                    addMessageToChat("error", "❌ 工具执行失败: " + data.error);
                }
            })
            .catch(error => {
                console.error('工具调用失败:', error);
                addMessageToChat("error", "❌ 网络错误: " + error.message);
            });
        }
    });
  
    function fallbackCopyTextToClipboard(text) {
        var textArea = document.createElement("textarea");
        textArea.value = text;
        
        // 避免滚动到底部
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";
        textArea.style.opacity = "0";
        
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            var successful = document.execCommand('copy');
            if (successful) {
                RED.notify("JSON数据已复制到剪贴板", "success");
            } else {
                RED.notify("复制失败", "error");
            }
        } catch (err) {
            console.error('降级复制方案失败:', err);
            RED.notify("复制失败", "error");
        }
        
        document.body.removeChild(textArea);
    }
    // 重置按钮状态的辅助函数
    function resetButton($button) {
        $button.prop('disabled', false)
            .css('background', '#dc3545')
            .html('<i class="fa fa-exclamation" style="font-size: 9px;"></i> 失败');
        
        // 3秒后恢复按钮
        setTimeout(() => {
            $button.css('background', '#28a745')
                   .html('<i class="fa fa-check" style="font-size: 9px;"></i> Apply');
        }, 3000);
    }
    // 添加代码块工具栏事件处理
    $(document).on('click', '.code-collapse-btn', function(e) {
        e.preventDefault();
        
        var blockId = $(this).data('block-id');
        var $pre = $('#' + blockId);
        var $code = $pre.find('code');
        var $icon = $(this).find('i');
        
        if ($code.is(':visible')) {
            // 折叠
            $code.slideUp(200);
            $icon.removeClass('fa-chevron-down').addClass('fa-chevron-right');
            $pre.css('height', '32px');
        } else {
            // 展开
            $code.slideDown(200);
            $icon.removeClass('fa-chevron-right').addClass('fa-chevron-down');
            $pre.css('height', 'auto');
        }
    });

    // 代码块运行按钮事件处理
    $(document).on('click', '.code-run-btn', function(e) {
        e.preventDefault();
        
        var $button = $(this);
        var blockId = $button.data('block-id');
        var jsonContent = $button.data('json-content');
        
        console.log('代码块运行按钮被点击:', blockId);
        
        if (!jsonContent) {
            RED.notify('未找到有效的JSON配置', 'error');
            return;
        }
        
        // 获取配置节点ID
        var nodeId = getSelectedConfigNodeId();
        if (!nodeId) {
            RED.notify('未找到配置节点，请先创建并配置API密钥', 'error');
            return;
        }
        
        // 获取当前选中的流程
        var selectedFlow = null;
        try {
            var activeWorkspace = RED.workspaces.active();
            if (activeWorkspace) {
                selectedFlow = {
                    id: activeWorkspace,
                    label: RED.nodes.workspace(activeWorkspace).label
                };
            }
        } catch (error) {
            console.warn("获取当前流程失败:", error);
        }
        
        // 构建工具参数
        var toolArgs = {
            flowJson: JSON.stringify(jsonContent),
            label: jsonContent.label || '新流程',
            description: jsonContent.description || ''
        };
        
        // 如果有选中的流程，在当前流程中创建
        if (selectedFlow && selectedFlow.id) {
            toolArgs.flowId = selectedFlow.id;
        }
        
        console.log('执行create-flow工具:', toolArgs);
        
        // 更新按钮状态
        $button.prop('disabled', true)
               .html('<i class="fa fa-spinner fa-spin" style="font-size: 9px;"></i> 运行中...')
               .css({
                   'background': '#6c757d',
                   'cursor': 'not-allowed'
               });
        
        // 调用MCP工具
        fetch('/ai-sidebar/execute-tool', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                toolName: 'create-flow',
                toolArgs: toolArgs,
                nodeId: nodeId,
                selectedFlow: selectedFlow
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log('工具执行结果:', data);
            
            if (data.success) {
                // 成功执行
                $button.css({
                        'background': '#28a745',
                        'cursor': 'default'
                    })
                    .html('<i class="fa fa-check" style="font-size: 9px;"></i> 已完成')
                    .prop('disabled', true);
                
                // 显示成功消息
                addMessageToChat("system", "✅ 流程创建成功！");
                
                // 刷新视图
                if (typeof RED !== 'undefined' && RED.view) {
                    RED.view.redraw();
                }
            } else {
                // 执行失败
                $button.prop('disabled', false)
                    .css('background', '#dc3545')
                    .html('<i class="fa fa-exclamation" style="font-size: 9px;"></i> 失败');
                
                addMessageToChat("error", "❌ 工具执行失败: " + data.error);
                
                // 3秒后恢复按钮
                setTimeout(() => {
                    $button.css('background', '#28a745')
                           .html('<i class="fa fa-play" style="font-size: 9px;"></i> Apply');
                }, 3000);
            }
        })
        .catch(error => {
            console.error('工具调用失败:', error);
            
            $button.prop('disabled', false)
                .css('background', '#dc3545')
                .html('<i class="fa fa-exclamation" style="font-size: 9px;"></i> 错误');
            
            addMessageToChat("error", "❌ 网络错误: " + error.message);
            
            // 3秒后恢复按钮
            setTimeout(() => {
                $button.css('background', '#28a745')
                       .html('<i class="fa fa-play" style="font-size: 9px;"></i> Apply');
            }, 3000);
        });
    });
    // 添加代码查看功能的事件处理
    $(document).on('click', '.code-view-btn', function(e) {
        e.preventDefault();
        
        var codeId = $(this).attr('data-code-id');
        
        if (codeId && window.nodeRedFunctionCodes) {
            var codeData = window.nodeRedFunctionCodes[codeId];
            
            if (codeData) {
                showFunctionCodeModal(codeData);
            }
        }
    });

    // 添加动作类型按钮的事件处理
    $(document).on('click', '.action-type-btn', function(e) {
        e.preventDefault();
        
        var buttonActionType = $(this).attr('data-action-type');
        var messageContainer = $(this).closest('.augment-message-container');
        
        console.log('点击动作按钮:', buttonActionType);
        
        // 查找消息中的JSON内容
        var jsonContent = extractJSONFromMessage(messageContainer);
        
        if (jsonContent) {
            try {
                var parsedJson = JSON.parse(jsonContent);
                
                // 构建动作数据
                var actionData = {
                    type: 'action_button',
                    actionType: buttonActionType,
                    toolName: getToolNameForAction(buttonActionType),
                    toolArgs: buildToolArgsForAction(buttonActionType, parsedJson),
                    jsonContent: JSON.stringify(parsedJson, null, 2),
                    buttonText: getButtonTextForAction(buttonActionType),
                    buttonColor: getButtonColorForAction(buttonActionType),
                    buttonIcon: getButtonIconForAction(buttonActionType),
                    description: getDescriptionForAction(buttonActionType)
                };
                
                console.log('构建动作数据:', actionData);
                
                // 替换动作按钮为Apply按钮
                var messageId = messageContainer.attr('id');
                if (messageId) {
                    // 移除原有的动作按钮
                    $(this).parent().remove();
                    
                    // 添加Apply按钮
                    addActionButton(messageId, actionData);
                }
                
            } catch (error) {
                console.error('处理动作失败:', error);
                RED.notify('动作处理失败: ' + error.message, 'error');
            }
        } else {
            console.warn('未找到JSON内容');
            RED.notify('未找到有效的配置内容', 'warning');
        }
    });

    // 从消息中提取JSON内容
    function extractJSONFromMessage(messageContainer) {
        var jsonContent = '';
        
        // 查找代码块中的JSON
        messageContainer.find('pre code').each(function() {
            var codeText = $(this).text().trim();
            if (codeText.startsWith('{') && codeText.endsWith('}')) {
                try {
                    JSON.parse(codeText);
                    jsonContent = codeText;
                    return false; // 找到第一个有效JSON就停止
                } catch (e) {
                    // 继续查找
                }
            }
        });
        
        return jsonContent;
    }

    // 获取动作对应的工具名称
    function getToolNameForAction(actionType) {
        const toolMap = {
            'CREATE': 'create-flow',
            'MODIFY': 'update-flow', 
            'DELETE': 'delete-flow',
            'INSTALL': 'install-nodes',
            'RESTART': 'restart-nodered',
            'CONFIG': 'update-config',
            'DEPLOY': 'deploy-flows',
            'BACKUP': 'backup-flows',
            'RESTORE': 'restore-flows'
        };
        return toolMap[actionType] || 'unknown-action';
    }

    // 获取动作对应的按钮文本
    function getButtonTextForAction(actionType) {
        const textMap = {
            'CREATE': 'Create Flow',
            'MODIFY': 'Modify Flow',
            'DELETE': 'Delete Flow', 
            'INSTALL': 'Install Nodes',
            'RESTART': 'Restart Node-RED',
            'CONFIG': 'Update Config',
            'DEPLOY': 'Deploy Changes',
            'BACKUP': 'Backup Flows',
            'RESTORE': 'Restore Flows'
        };
        return textMap[actionType] || 'Execute';
    }

    // 获取动作对应的按钮颜色
    function getButtonColorForAction(actionType) {
        const colorMap = {
            'CREATE': '#10b981',
            'MODIFY': '#3b82f6',
            'DELETE': '#ef4444',
            'INSTALL': '#8b5cf6',
            'RESTART': '#f59e0b',
            'CONFIG': '#6b7280',
            'DEPLOY': '#059669',
            'BACKUP': '#0891b2',
            'RESTORE': '#7c3aed'
        };
        return colorMap[actionType] || '#6b7280';
    }

    // 获取动作对应的按钮图标
    function getButtonIconForAction(actionType) {
        const iconMap = {
            'CREATE': 'fa-plus',
            'MODIFY': 'fa-edit',
            'DELETE': 'fa-trash',
            'INSTALL': 'fa-download',
            'RESTART': 'fa-refresh',
            'CONFIG': 'fa-cog',
            'DEPLOY': 'fa-rocket',
            'BACKUP': 'fa-save',
            'RESTORE': 'fa-upload'
        };
        return iconMap[actionType] || 'fa-play';
    }

    // 获取动作对应的描述
    function getDescriptionForAction(actionType) {
        const descMap = {
            'CREATE': '点击创建新的流程',
            'MODIFY': '点击修改现有流程',
            'DELETE': '点击删除选中流程',
            'INSTALL': '点击安装Node-RED节点包',
            'RESTART': '点击重启Node-RED服务',
            'CONFIG': '点击更新Node-RED配置',
            'DEPLOY': '点击部署当前更改',
            'BACKUP': '点击备份当前流程',
            'RESTORE': '点击恢复流程备份'
        };
        return descMap[actionType] || '点击执行操作';
    }

    // 构建动作对应的工具参数
    function buildToolArgsForAction(actionTypeParam, parsedJson) {
        switch (actionTypeParam) {
            case 'CREATE':
            case 'MODIFY':
                return {
                    flowJson: JSON.stringify(parsedJson),
                    label: parsedJson.label || '新流程',
                    description: parsedJson.description || ''
                };
            case 'INSTALL':
                return {
                    packages: parsedJson.packages || [],
                    description: parsedJson.description || ''
                };
            case 'CONFIG':
                return {
                    settings: parsedJson.settings || {},
                    description: parsedJson.description || ''
                };
            case 'RESTART':
                return {
                    reason: parsedJson.reason || '用户请求重启',
                    backup: parsedJson.backup !== false
                };
            case 'BACKUP':
                return {
                    name: parsedJson.name || `backup_${new Date().toISOString().slice(0,10)}`,
                    description: parsedJson.description || ''
                };
            case 'RESTORE':
                return {
                    backupName: parsedJson.backupName || '',
                    description: parsedJson.description || ''
                };
            default:
                return parsedJson;
        }
    }

    function createDefaultApiConfigNode() {
        try {
            // 检查api-config节点类型是否已注册
            var apiConfigNodeType = RED.nodes.getType("api-config");
            if (!apiConfigNodeType) {
                console.error("api-config节点类型未注册");
                return null;
            }
            
            // 创建默认的api-config节点
            var defaultConfigNode = {
                id: RED.nodes.id(),
                _def: apiConfigNodeType,
                type: "api-config",
                hasUsers: false,
                users: [],
                name: "Default AI Config",
                label: function() { return this.name || "Default AI Config"; },
                provider: "openai",
                model: "gpt-4o-mini",
                temperature: 0.1,
                maxTokens: 2000,
                useDifferentModels: false,
                planningModel: "",
                executionModel: "",
                credentials: {
                    apiKey: "请配置API密钥" // 临时占位符
                }
            };
            
            // 添加到Node-RED节点集合
            RED.nodes.add(defaultConfigNode);
            RED.nodes.dirty(true);
            
            console.log("创建默认api-config节点:", defaultConfigNode.id);
            
            // 立即部署以确保节点保存到后端
            RED.deploy.setDeployInflight(false);
            RED.nodes.dirty(true);
            
            // 提示用户配置并部署
            setTimeout(function() {
                RED.notify("已创建默认AI配置节点，请配置API密钥并点击部署按钮", "info");
                RED.editor.editConfig("", "api-config", defaultConfigNode.id);
            }, 1000);
            
            return defaultConfigNode.id;
        } catch (error) {
            console.error("创建默认配置节点失败:", error);
            return null;
        }
    }

    // 全局变量存储当前会话ID
    var currentSessionId = null;
    
    // 获取或生成当前会话ID
    function getCurrentSessionId() {
        if (!currentSessionId) {
            // 尝试从localStorage获取
            currentSessionId = localStorage.getItem('node-red-ai-session-id');
            if (!currentSessionId) {
                // 生成新的会话ID
                currentSessionId = 'session-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('node-red-ai-session-id', currentSessionId);
            }
        }
        return currentSessionId;
    }
    
    function getChatHistory(callback) {
        // 首先尝试从后端API获取SQLite数据库中的历史记录
        var sessionId = getCurrentSessionId();
        
        $.ajax({
            url: '/ai-sidebar/history/' + sessionId,
            method: 'GET',
            data: { limit: 20 },
            success: function(response) {
                console.log('从数据库获取到聊天历史:', response);
                var history = [];
                
                if (response.history && response.history.length > 0) {
                    // 处理数据库中的历史记录
                    history = response.history.map(function(item) {
                        var timestamp = new Date(item.timestamp).toLocaleString();
                        return {
                            role: item.role,
                            content: item.content,
                            timestamp: timestamp,
                            preview: item.content.length > 30 ? item.content.substring(0, 30) + '...' : item.content
                        };
                    });
                }
                
                // 如果数据库中没有历史记录，从DOM中获取当前会话的消息
                if (history.length === 0) {
                    console.log('数据库中无历史记录，从DOM获取当前会话消息');
                    $("#augment-chat-messages .augment-message-container").each(function() {
                        var role = $(this).hasClass("user-message") ? "user" : "assistant";
                        var content = $(this).find(".message-content").text().trim();
                        var timestamp = $(this).find(".message-timestamp").text() || new Date().toLocaleTimeString();
                        if (content && content !== "🤖 正在思考...") {
                            history.push({
                                role: role,
                                content: content,
                                timestamp: timestamp,
                                preview: content.length > 30 ? content.substring(0, 30) + '...' : content
                            });
                        }
                    });
                }
                
                if (callback) callback(history.slice(-20));
            },
            error: function(xhr, status, error) {
                console.error('获取聊天历史失败:', error);
                // 出错时从DOM获取当前会话消息作为备选方案
                var history = [];
                $("#augment-chat-messages .augment-message-container").each(function() {
                    var role = $(this).hasClass("user-message") ? "user" : "assistant";
                    var content = $(this).find(".message-content").text().trim();
                    var timestamp = $(this).find(".message-timestamp").text() || new Date().toLocaleTimeString();
                    if (content && content !== "🤖 正在思考...") {
                        history.push({
                            role: role,
                            content: content,
                            timestamp: timestamp,
                            preview: content.length > 30 ? content.substring(0, 30) + '...' : content
                        });
                    }
                });
                if (callback) callback(history.slice(-20));
            }
        });
    }

    // 聊天历史记录下拉菜单功能
    function initChatHistoryDropdown() {
        console.log('初始化聊天历史下拉菜单');
        
        // 点击下拉按钮
        $(document).on('click', '#chat-history-dropdown-btn', function(e) {
            e.preventDefault();
            e.stopPropagation();
            
            var $menu = $('#chat-history-dropdown-menu');
            var isVisible = $menu.is(':visible');
            
            if (isVisible) {
                $menu.hide();
                $(this).find('.fa-chevron-down, .fa-chevron-up').removeClass('fa-chevron-up').addClass('fa-chevron-down');
            } else {
                // 更新历史记录内容
                updateChatHistoryMenu();
                $menu.show();
                $(this).find('.fa-chevron-down').removeClass('fa-chevron-down').addClass('fa-chevron-up');
            }
        });
        
        // 点击其他地方关闭菜单
        $(document).on('click', function(e) {
            if (!$(e.target).closest('.chat-history-dropdown-container').length) {
                $('#chat-history-dropdown-menu').hide();
                $('#chat-history-dropdown-btn .fa-chevron-up').removeClass('fa-chevron-up').addClass('fa-chevron-down');
            }
        });
        
        // 点击历史记录项
        $(document).on('click', '.chat-history-item', function(e) {
            e.preventDefault();
            var sessionId = $(this).data('session-id');
            if (sessionId) {
                // 切换到选中的会话
                switchToSession(sessionId);
                // 关闭下拉菜单
                $('#chat-history-dropdown-menu').hide();
                $('#chat-history-dropdown-btn .fa-chevron-up').removeClass('fa-chevron-up').addClass('fa-chevron-down');
            }
        });
    }
    
    // 更新聊天历史菜单内容
    function updateChatHistoryMenu() {
        var $menu = $('#chat-history-dropdown-menu');
        
        // 显示加载状态
        $menu.html(`
            <div class="chat-history-loading" style="
                padding: 16px;
                text-align: center;
                color: #6b7280;
                font-size: 12px;
            ">正在加载会话历史...</div>
        `);
        
        // 获取会话列表
        $.ajax({
            url: '/ai-sidebar/sessions',
            method: 'GET',
            data: { limit: 20 },
            success: function(response) {
                console.log('获取到会话列表:', response);
                
                if (!response.sessions || response.sessions.length === 0) {
                    $menu.html(`
                        <div class="chat-history-empty" style="
                            padding: 16px;
                            text-align: center;
                            color: #9ca3af;
                            font-size: 12px;
                        ">暂无会话历史</div>
                    `);
                    return;
                }
                
                var menuHtml = '';
                
                // 显示会话列表
                var sessions = response.sessions.slice(0, 15); // 显示最近15个会话
            
                if (sessions.length > 0) {
                    menuHtml += `
                        <div class="chat-history-section" style="
                            padding: 8px 0;
                            border-bottom: 1px solid #f3f4f6;
                        ">
                            <div class="chat-history-section-title" style="
                                padding: 4px 12px;
                                font-size: 11px;
                                font-weight: 600;
                                color: #6b7280;
                                text-transform: uppercase;
                                letter-spacing: 0.5px;
                            ">历史会话</div>
                    `;
                    
                    sessions.forEach(function(session, index) {
                        // 使用第一条用户消息作为标题，如果没有则使用默认标题
                        var sessionTitle = session.first_user_message 
                            ? (session.first_user_message.length > 30 
                                ? session.first_user_message.substring(0, 30) + '...' 
                                : session.first_user_message)
                            : (session.title || `会话 ${session.id.substring(0, 8)}`);
                        var lastMessageTime = session.last_message_time ? new Date(session.last_message_time).toLocaleString() : '未知时间';
                        var messageCount = session.message_count || 0;
                        var scenarioIcon = session.scenario === 'learning' ? '📚' : (session.scenario === 'solution' ? '🔧' : '💡');
                        
                        menuHtml += `
                            <div class="chat-history-item" data-session-id="${session.id}" style="
                                padding: 8px 12px;
                                cursor: pointer;
                                border-bottom: ${index < sessions.length - 1 ? '1px solid #f9fafb' : 'none'};
                                transition: background-color 0.1s;
                                min-width: 0;
                            " onmouseover="this.style.backgroundColor='#f9fafb'" onmouseout="this.style.backgroundColor='transparent'">
                                <div style="
                                    display: flex;
                                    align-items: center;
                                    gap: 6px;
                                    margin-bottom: 4px;
                                ">
                                    <span style="font-size: 10px;">${scenarioIcon}</span>
                                    <span style="
                                        font-size: 12px;
                                        font-weight: 600;
                                        color: #374151;
                                        flex: 1;
                                        white-space: nowrap;
                                        overflow: hidden;
                                        text-overflow: ellipsis;
                                    ">${sessionTitle}</span>
                                    <span style="
                                        font-size: 9px;
                                        color: #9ca3af;
                                        background: #f3f4f6;
                                        padding: 2px 6px;
                                        border-radius: 10px;
                                    ">${messageCount}条</span>
                                </div>
                                <div style="
                                    font-size: 10px;
                                    color: #6b7280;
                                    padding-left: 16px;
                                ">${lastMessageTime}</div>
                            </div>
                        `;
                    });
                    
                    menuHtml += '</div>';
                }
            
            // 添加清空历史按钮
            menuHtml += `
                <div class="chat-history-actions" style="
                    padding: 8px;
                    border-top: 1px solid #f3f4f6;
                    background: #f9fafb;
                ">
                    <button onclick="clearChatHistory()" style="
                        width: 100%;
                        padding: 6px 12px;
                        background: #ef4444;
                        color: white;
                        border: none;
                        border-radius: 4px;
                        font-size: 11px;
                        cursor: pointer;
                        transition: background-color 0.1s;
                    " onmouseover="this.style.backgroundColor='#dc2626'" onmouseout="this.style.backgroundColor='#ef4444'">清空历史记录</button>
                </div>
            `;
            
                $menu.html(menuHtml);
            },
            error: function(xhr, status, error) {
                console.error('获取会话列表失败:', error);
                $menu.html(`
                    <div class="chat-history-error" style="
                        padding: 16px;
                        text-align: center;
                        color: #ef4444;
                        font-size: 12px;
                    ">加载会话失败，请重试</div>
                `);
            }
        });

    }
    
    // 切换到指定会话
    function switchToSession(sessionId) {
        console.log('切换到会话:', sessionId);
        
        // 更新当前会话ID
        currentSessionId = sessionId;
        localStorage.setItem('node-red-ai-session-id', sessionId);
        
        // 获取该会话的对话历史
        $.ajax({
            url: '/ai-sidebar/history/' + sessionId,
            method: 'GET',
            data: { limit: 50 },
            success: function(response) {
                console.log('获取到会话历史:', response);
                
                // 清空当前聊天区域
                $('#augment-chat-messages').empty();
                
                if (response.history && response.history.length > 0) {
                    // 添加系统提示消息
                    addMessageToChat('system', `📋 已切换到会话: ${sessionId.substring(0, 8)}`);
                    
                    // 重新显示历史对话
                    response.history.forEach(function(msg, index) {
                        var messageId = 'session-' + Date.now() + '-' + index;
                        addMessageToChat(msg.role, msg.content, messageId);
                    });
                    
                    console.log('会话历史已加载，共', response.history.length, '条记录');
                } else {
                    // 添加系统提示消息
                    addMessageToChat('system', `📋 已切换到新会话: ${sessionId.substring(0, 8)}`);
                }
                
                // 滚动到底部
                setTimeout(function() {
                    forceScrollToBottom();
                }, 100);
            },
            error: function(xhr, status, error) {
                console.error('获取会话历史失败:', error);
                // 即使失败也要切换会话ID
                $('#augment-chat-messages').empty();
                addMessageToChat('system', `⚠️ 切换到会话: ${sessionId.substring(0, 8)} (历史加载失败)`);
            }
        });
    }
    
    // 回显和召回聊天历史记录
    function recallChatHistory(selectedContent) {
        console.log('开始回显聊天历史记录:', selectedContent);
        
        // 获取完整的聊天历史
        getChatHistory(function(history) {
            if (history.length === 0) {
                console.log('没有找到聊天历史记录');
                // 如果没有历史记录，只将选中的内容填入输入框
                $('#augment-input').val(selectedContent).focus();
                return;
            }
            
            // 清空当前聊天区域
            $('#augment-chat-messages').empty();
            
            // 添加系统提示消息
            addMessageToChat('system', '📋 已召回聊天历史记录');
            
            // 重新显示历史对话
            history.forEach(function(msg, index) {
                var messageId = 'recalled-' + Date.now() + '-' + index;
                addMessageToChat(msg.role, msg.content, messageId);
            });
            
            // 将选中的内容填入输入框
            $('#augment-input').val(selectedContent).focus();
            
            // 滚动到底部
            setTimeout(function() {
                forceScrollToBottom();
            }, 100);
            
            console.log('聊天历史记录已成功回显，共', history.length, '条记录');
        });
    }
    
    // 清空聊天历史
    function clearChatHistory() {
        $('#augment-chat-messages').empty();
        console.log('聊天历史已清空');
    }

    function saveChatMessage(role, content) {
        // 保存消息到Node-RED的全局上下文（可选）
        try {
            var context = RED.settings.get('contextStorage') || {};
            if (context.default && context.default.module === 'localfilesystem') {
                // 如果配置了文件存储，可以保存聊天记录
                console.log("保存聊天记录:", role, content);
            }
        } catch (error) {
            console.warn("保存聊天记录失败:", error);
        }
    }

    // 获取当前选择的模型信息
    function getCurrentModelInfo() {
        try {
            var nodeId = getSelectedConfigNodeId();
            if (!nodeId) {
                return { name: 'AI Assistant', firstLetter: 'A' };
            }
            
            var configNode = RED.nodes.node(nodeId);
            if (!configNode) {
                return { name: 'AI Assistant', firstLetter: 'A' };
            }
            
            var provider = configNode.provider || 'openai';
            
            // 根据提供商生成显示名称和首字母
            var displayName = '';
            var firstLetter = '';
            
            switch (provider.toLowerCase()) {
                case 'openai':
                    displayName = 'OpenAI';
                    firstLetter = 'O';
                    break;
                case 'deepseek':
                    displayName = 'DeepSeek';
                    firstLetter = 'D';
                    break;
                case 'anthropic':
                    displayName = 'Claude';
                    firstLetter = 'C';
                    break;
                case 'google':
                    displayName = 'Gemini';
                    firstLetter = 'G';
                    break;
                default:
                    displayName = provider.charAt(0).toUpperCase() + provider.slice(1);
                    firstLetter = provider.charAt(0).toUpperCase();
            }
            
            return { name: displayName, firstLetter: firstLetter };
        } catch (error) {
            console.warn('获取模型信息失败:', error);
            return { name: 'AI Assistant', firstLetter: 'A' };
        }
    }

    // Add message to chat UI with markdown rendering
    function addMessageToChat(role, content, messageId) {
        loadAISidebarConfig().then(function(config) {
            var isUser = role === "user";
            var userLabel = config.ui.userLabel;
            
            // 根据角色设置标签和图标
            var label, avatarContent;
            if (isUser) {
                label = userLabel;
                avatarContent = userLabel.charAt(0).toUpperCase();
            } else {
                // AI消息显示当前厂商名称
                var modelInfo = getCurrentModelInfo();
                label = modelInfo.name;
                avatarContent = modelInfo.firstLetter;
            }
            
            var timestamp = new Date().toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit',
                hour12: true 
            });
            
            var messageHtml = '<div class="augment-message-container ' + (isUser ? 'user-message' : 'assistant-message') + '" ' + 
                             (messageId ? 'id="' + messageId + '"' : '') + ' style="margin: 0 0 24px 0;">';
            
            // Message header
            messageHtml += '<div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">';
            messageHtml += '<div style="width: 24px; height: 24px; border-radius: 50%; background: ' + 
                          (isUser ? '#3b82f6' : '#10b981') + '; display: flex; align-items: center; justify-content: center;">';
            messageHtml += '<span style="color: white; font-size: 12px; font-weight: 600;">' + avatarContent + '</span>';
            messageHtml += '</div>';
            messageHtml += '<span style="font-weight: 600; color: #374151;">' + label + '</span>';
            
            // 添加场景信息，使用较小的字体
            if (!isUser && ScenarioManager.isLoaded) {
                var currentScenario = ScenarioManager.getCurrentScenario();
                // 获取实际的场景数据结构
                var scenarios = ScenarioManager.scenarios.scenarios || ScenarioManager.scenarios;
                if (scenarios[currentScenario]) {
                    var scenarioName = scenarios[currentScenario].name;
                    messageHtml += '<span style="color: #6b7280; font-size: 11px; font-weight: 400; margin-left: 4px;">- ' + scenarioName + '</span>';
                }
            }
            
            messageHtml += '<span style="color: #9ca3af; font-size: 12px; margin-left: auto;">' + timestamp + '</span>';
            messageHtml += '</div>';
            
            // Message content with markdown rendering
            var renderedContent = renderMarkdown(content);
            
            messageHtml += '<div class="message-content" style="background: ' + (isUser ? '#f3f4f6' : '#ffffff') + 
                          '; padding: 12px 16px; border-radius: 12px; border: 1px solid #e5e7eb; word-wrap: break-word; line-height: 1.5;">';
            messageHtml += renderedContent;
            messageHtml += '</div>';
            messageHtml += '</div>';
            
            $("#augment-chat-messages").append(messageHtml);
            
            // 获取刚添加的消息元素
            var messageElement = $("#augment-chat-messages .augment-message-container").last();
            
            // Apply syntax highlighting if highlight.js is available
            if (typeof hljs !== 'undefined') {
                messageElement.find('pre code').each(function(i, block) {
                    try {
                        hljs.highlightElement(block);
                    } catch (e) {
                        console.warn('语法高亮失败:', e);
                    }
                });
            }
            
            // 检测动作标记
            if (messageId) {
                detectAndProcessActionMarkers(messageId);
            }
            
            // Add markdown styles
            addMarkdownStyles();
            
            forceScrollToBottom();
        });
    }

    // Add markdown styles to the page
    function addMarkdownStyles() {
        // Check if styles already added
        if (document.getElementById('markdown-styles')) {
            return;
        }
        
        var style = document.createElement('style');
        style.id = 'markdown-styles';
        style.textContent = `
            /* 使用更高优先级的选择器覆盖Node-RED默认样式 */
            .augment-message-container .message-content h1, 
            .augment-message-container .message-content h2, 
            .augment-message-container .message-content h3, 
            .augment-message-container .message-content h4, 
            .augment-message-container .message-content h5, 
            .augment-message-container .message-content h6 {
                margin: 16px 0 8px 0 !important;
                font-weight: 600 !important;
                line-height: 1.25 !important;
                color: #1f2937 !important;
            }
            .augment-message-container .message-content h1 { 
                font-size: 1.5em !important; 
                border-bottom: 1px solid #e5e7eb !important; 
                padding-bottom: 8px !important; 
            }
            .augment-message-container .message-content h2 { font-size: 1.3em !important; }
            .augment-message-container .message-content h3 { font-size: 1.1em !important; }
            .augment-message-container .message-content h4, 
            .augment-message-container .message-content h5, 
            .augment-message-container .message-content h6 { font-size: 1em !important; }
            
            .augment-message-container .message-content p {
                margin: 8px 0 !important;
                line-height: 1.6 !important;
                color: #374151 !important;
            }
            
            .augment-message-container .message-content ul, 
            .augment-message-container .message-content ol {
                margin: 8px 0 !important;
                padding-left: 20px !important;
            }
            .augment-message-container .message-content li {
                margin: 4px 0 !important;
                line-height: 1.5 !important;
                color: #374151 !important;
            }
            
            .augment-message-container .message-content blockquote {
                margin: 12px 0 !important;
                padding: 8px 16px !important;
                border-left: 4px solid #e5e7eb !important;
                background: #f9fafb !important;
                font-style: italic !important;
                color: #6b7280 !important;
            }
            
            .augment-message-container .message-content pre {
                margin: 12px 0 !important;
                padding: 12px !important;
                background: #f8fafc !important;
                border: 1px solid #e2e8f0 !important;
                border-radius: 6px !important;
                overflow-x: auto !important;
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace !important;
                font-size: 13px !important;
                line-height: 1.4 !important;
                white-space: pre !important;
            }
            
            .augment-message-container .message-content code {
                background: #f1f5f9 !important;
                padding: 2px 4px !important;
                border-radius: 3px !important;
                font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', 'Consolas', monospace !important;
                font-size: 0.9em !important;
                color: #dc2626 !important;
            }
            
            .augment-message-container .message-content pre code {
                background: none !important;
                padding: 0 !important;
                border-radius: 0 !important;
                color: #334155 !important;
            }
            
            .augment-message-container .message-content table {
                margin: 12px 0 !important;
                border-collapse: collapse !important;
                width: 100% !important;
            }
            .augment-message-container .message-content th, 
            .augment-message-container .message-content td {
                border: 1px solid #e5e7eb !important;
                padding: 8px 12px !important;
                text-align: left !important;
            }
            .augment-message-container .message-content th {
                background: #f9fafb !important;
                font-weight: 600 !important;
            }
            
            .augment-message-container .message-content a {
                color: #3b82f6 !important;
                text-decoration: none !important;
            }
            .augment-message-container .message-content a:hover {
                text-decoration: underline !important;
            }
            
            .augment-message-container .message-content hr {
                margin: 16px 0 !important;
                border: none !important;
                border-top: 1px solid #e5e7eb !important;
            }
            
            .augment-message-container .message-content strong {
                font-weight: 600 !important;
                color: #1f2937 !important;
            }
            
            .augment-message-container .message-content em {
                font-style: italic !important;
                color: #6b7280 !important;
            }
            
            .augment-message-container .message-content del {
                text-decoration: line-through !important;
                color: #9ca3af !important;
            }
            
            /* Task list styles */
            .augment-message-container .message-content input[type="checkbox"] {
                margin-right: 8px !important;
            }
            
            /* Highlight.js theme override for better integration */
            .augment-message-container .message-content .hljs {
                background: #f8fafc !important;
                color: #334155 !important;
            }
        `;
        document.head.appendChild(style);
    }

    // Append content to existing message with markdown rendering
    function appendToMessage(messageId, content) {
        var messageElement = $("#" + messageId + " .message-content");
        if (messageElement.length > 0) {
            // Get current text content (not HTML to avoid double-rendering)
            var currentText = messageElement.attr('data-raw-text') || '';
            var newText = currentText + content;
            
            // Store raw text for future appends
            messageElement.attr('data-raw-text', newText);
            
            // Render combined content as markdown
            var renderedContent = renderMarkdown(newText);
            
            messageElement.html(renderedContent);
            
            // Apply syntax highlighting if highlight.js is available
            if (typeof hljs !== 'undefined') {
                messageElement.find('pre code').each(function(i, block) {
                    try {
                        hljs.highlightElement(block);
                    } catch (e) {
                        console.warn('语法高亮失败:', e);
                    }
                });
            }
            
            // 增强代码块显示 - 确保在语法高亮后执行
            setTimeout(function() {
                enhanceCodeBlocks(messageElement);
            }, 100);
            
            // 滚动到底部
            forceScrollToBottom();
        }
    }

    // Load external libraries for markdown rendering
    function loadMarkdownLibraries() {
        return new Promise((resolve) => {
            let loadedCount = 0;
            const totalLibraries = 2;
            
            function checkComplete() {
                loadedCount++;
                if (loadedCount === totalLibraries) {
                    console.log('所有Markdown库加载完成');
                    resolve();
                }
            }
            
            // Load showdown.js for markdown rendering
            if (typeof showdown === 'undefined') {
                var showdownScript = document.createElement('script');
                showdownScript.src = 'https://cdn.jsdelivr.net/npm/showdown@2.1.0/dist/showdown.min.js';
                showdownScript.onload = function() {
                    console.log('Showdown markdown library loaded');
                    checkComplete();
                };
                showdownScript.onerror = function() {
                    console.warn('Showdown加载失败，使用降级方案');
                    checkComplete();
                };
                document.head.appendChild(showdownScript);
            } else {
                checkComplete();
            }
            
            // Load highlight.js for syntax highlighting
            if (typeof hljs === 'undefined') {
                var hlScript = document.createElement('script');
                hlScript.src = 'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/highlight.min.js';
                hlScript.onload = function() {
                    console.log('Highlight.js library loaded');
                    
                    // Load CSS for highlight.js
                    var hlCss = document.createElement('link');
                    hlCss.rel = 'stylesheet';
                    hlCss.href = 'https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.9.0/build/styles/github.min.css';
                    document.head.appendChild(hlCss);
                    
                    checkComplete();
                };
                hlScript.onerror = function() {
                    console.warn('Highlight.js加载失败');
                    checkComplete();
                };
                document.head.appendChild(hlScript);
            } else {
                checkComplete();
            }
        });
    }
    
    function forceScrollToBottom() {
        // 方法1：使用jQuery的scrollTop
        var chatContainer = $("#augment-chat-messages");
        chatContainer.scrollTop(chatContainer[0].scrollHeight);
        
        // 方法2：使用原生JavaScript的scrollTo
        var container = document.getElementById("augment-chat-messages");
        if (container) {
            container.scrollTo(0, container.scrollHeight);
        }
        
        // 方法3：使用setTimeout确保DOM已更新
        setTimeout(function() {
            chatContainer.scrollTop(chatContainer[0].scrollHeight);
        }, 50);
    }
    // 添加配置加载函数
    function loadAISidebarConfig() {
        return Promise.resolve({
            ui: {
                placeholder: "Ask or instruct Augment",
                currentFlow: "当前流程",
                currentNode: "当前节点",
                noFlowSelected: "未选择流程",
                noNodeSelected: "未选择节点",
                multipleNodesSelected: "已选择 {count} 个节点",
                nodeType: "类型",
                timestamp: "07:51 PM",
                userLabel: "You",
                assistantLabel: "Augment"
            },
            messages: {
                developmentInProgress: "此功能正在开发中",
                simulatedResponse: "这是一个模拟的AI回复。"
            }
        });
    }
    // 添加动作按钮到消息
    function addActionButton(messageId, buttonData) {
        var messageElement = $("#" + messageId);
        if (messageElement.length > 0) {
            console.log("添加按钮到消息:", messageId, buttonData);
            
            // 创建按钮HTML，模仿Augment UI风格的Apply按钮
            var buttonHtml = `
                <div class="action-button-container" style="
                    margin-top: 16px; 
                    padding: 0;
                    display: flex;
                    justify-content: flex-end;
                ">
                    <button class="execute-tool-btn" 
                            data-tool-name="${buttonData.toolName}" 
                            data-tool-args='${JSON.stringify(buttonData.toolArgs)}'
                            style="
                                background: #10b981;
                                border: 1px solid #10b981;
                                border-radius: 6px;
                                padding: 6px 12px;
                                font-size: 13px;
                                color: white;
                                cursor: pointer;
                                display: inline-flex;
                                align-items: center;
                                gap: 6px;
                                transition: all 0.2s;
                                font-weight: 500;
                                min-width: 60px;
                                justify-content: center;
                            "
                            onmouseover="this.style.background='#059669'"
                            onmouseout="this.style.background='#10b981'">
                        <i class="fa fa-check" style="font-size: 12px;"></i>
                        Apply
                    </button>
                </div>
            `;
            
            messageElement.find('.message-content').append(buttonHtml);
            forceScrollToBottom();
        } else {
            console.warn("找不到消息元素:", messageId);
        }
    }

    // 按钮点击事件处理
    $(document).on('click', '.execute-tool-btn', function() {
        var toolName = $(this).data('tool-name');
        var toolArgs = $(this).data('tool-args');
        var button = $(this);
        var originalText = button.html();
        
        // 获取当前选中的流程信息
        var selectedFlow = null;
        try {
            var activeWorkspace = RED.workspaces.active();
            if (activeWorkspace) {
                selectedFlow = {
                    id: activeWorkspace,
                    label: RED.nodes.workspace(activeWorkspace).label
                };
            }
        } catch (error) {
            console.warn("获取当前流程失败:", error);
        }
        
        // 禁用按钮并显示加载状态
        button.prop('disabled', true)
              .html('<i class="fa fa-spinner fa-spin" style="font-size: 12px;"></i> 执行中...')
              .css({
                  'background': '#f3f4f6',
                  'color': '#6b7280',
                  'cursor': 'not-allowed'
              });
        
        // 获取配置节点ID
        var nodeId = getSelectedConfigNodeId();
        if (!nodeId) {
            addMessageToChat("error", "❌ 未找到配置节点，请先创建并配置API密钥");
            button.prop('disabled', false).html(originalText);
            return;
        }
        
        console.log('执行工具调用:', toolName, toolArgs, '当前流程:', selectedFlow);
        
        // 发送工具执行请求
        $.ajax({
            url: '/ai-sidebar/execute-tool',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                toolName: toolName,
                toolArgs: toolArgs,
                nodeId: nodeId,
                selectedFlow: selectedFlow
            }),
            success: function(response) {
                if (response.success) {
                    // 显示执行成功
                    button.html('<i class="fa fa-check" style="font-size: 12px;"></i> 已完成')
                          .css({
                              'background': '#dcfce7',
                              'color': '#166534',
                              'border-color': '#bbf7d0'
                          });
                    
                    // 添加成功消息
                    addMessageToChat("assistant", `✅ ${toolName} 执行成功！\n\n${response.result}`);
                    
                    // 如果是创建流程相关的工具，刷新工作区
                    if (['create-flow', 'update-flows', 'update-flow'].includes(toolName)) {
                        console.log('流程创建成功，刷新工作区');
                        
                        // 刷新工作区列表
                        if (RED.workspaces && RED.workspaces.refresh) {
                            RED.workspaces.refresh();
                        }
                        
                        // 重新加载流程
                        if (RED.deploy && RED.deploy.setDeployInflight) {
                            RED.deploy.setDeployInflight(false);
                        }
                        
                        // 触发视图重绘
                        setTimeout(function() {
                            if (RED.view && RED.view.redraw) {
                                RED.view.redraw();
                            }
                            
                            // 如果响应中包含流程ID，尝试切换到新流程
                            var flowIdMatch = response.result.match(/ID:\s*([a-f0-9]+)/);
                            if (flowIdMatch && flowIdMatch[1]) {
                                var newFlowId = flowIdMatch[1];
                                console.log('尝试切换到新流程:', newFlowId);
                                
                                // 切换到新创建的流程
                                if (RED.workspaces && RED.workspaces.show) {
                                    RED.workspaces.show(newFlowId);
                                }
                            }
                        }, 1000);
                    }
                } else {
                    // 显示执行失败
                    button.prop('disabled', false)
                          .html('<i class="fa fa-exclamation-triangle" style="font-size: 12px;"></i> 重试')
                          .css({
                              'background': '#fef2f2',
                              'color': '#dc2626',
                              'border-color': '#fecaca'
                          });
                    
                    addMessageToChat("error", `❌ 执行失败: ${response.error}`);
                }
            },
            error: function(xhr) {
                var error = xhr.responseJSON ? xhr.responseJSON.error : '网络错误';
                
                // 恢复按钮状态
                button.prop('disabled', false)
                      .html('<i class="fa fa-exclamation-triangle" style="font-size: 12px;"></i> 重试')
                      .css({
                          'background': '#fef2f2',
                          'color': '#dc2626',
                          'border-color': '#fecaca'
                      });
                
                addMessageToChat("error", `❌ 执行失败: ${error}`);
            }
        });
    });
    // 添加JSON编辑器到消息
    function addJSONEditor(messageId, editorData) {
        console.log("=== addJSONEditor 被调用 ===");
        console.log("messageId:", messageId);
        console.log("editorData:", editorData);
        
        var messageElement = $("#" + messageId);
        console.log("找到消息元素:", messageElement.length > 0);
        
        if (messageElement.length > 0) {
            var editorId = "json-editor-" + Date.now();
            
            // 创建编辑器HTML
            var editorHtml = `
                <div class="json-editor-container" style="margin-top: 16px;">
                    <div style="margin-bottom: 8px;">
                        <strong>${editorData.editorTitle || '流程配置'}</strong>
                    </div>
                    <div style="margin-bottom: 12px; color: #6b7280; font-size: 14px;">
                        ${editorData.description || ''}
                    </div>
                    <div id="${editorId}" style="
                        height: 300px;
                        border: 1px solid #e5e7eb;
                        border-radius: 6px;
                        margin-bottom: 12px;
                    "></div>
                    <div style="display: flex; justify-content: flex-end; gap: 8px;">
                        <button class="json-editor-apply-btn" 
                                data-editor-id="${editorId}"
                                data-tool-name="${editorData.toolName}" 
                                data-tool-args='${JSON.stringify(editorData.toolArgs)}'
                                style="
                                    background: #10b981;
                                    border: 1px solid #10b981;
                                    border-radius: 6px;
                                    padding: 8px 16px;
                                    font-size: 14px;
                                    color: white;
                                    cursor: pointer;
                                    display: inline-flex;
                                    align-items: center;
                                    gap: 6px;
                                    transition: all 0.2s;
                                    font-weight: 500;
                                "
                                onmouseover="this.style.background='#059669'"
                                onmouseout="this.style.background='#10b981'">
                            <i class="fa fa-check" style="font-size: 12px;"></i>
                            Apply
                        </button>
                    </div>
                </div>
            `;
            
            console.log("添加编辑器HTML");
            messageElement.find('.message-content').append(editorHtml);
            
            // 初始化JSON编辑器
            ensureAceEditorLoaded(function() {
                initializeJSONEditor(editorId, editorData.jsonContent);
            });
            
            // 添加Apply按钮点击事件
            messageElement.find('.json-editor-apply-btn').off('click').on('click', function() {
                console.log("JSON编辑器Apply按钮被点击");
                var editorId = $(this).data('editor-id');
                var toolName = $(this).data('tool-name');
                var originalToolArgs = $(this).data('tool-args');
                
                // 获取编辑器内容
                var editor = window.jsonEditors && window.jsonEditors[editorId];
                if (!editor) {
                    RED.notify("编辑器未找到", "error");
                    return;
                }
                
                var editedContent = editor.getValue();
                
                // 验证JSON格式
                try {
                    var parsedJson = JSON.parse(editedContent);
                    
                    // 更新工具参数
                    var updatedToolArgs = Object.assign({}, originalToolArgs);
                    if (toolName === 'create-flow') {
                        updatedToolArgs.flowJson = editedContent;
                    }
                    
                    console.log("执行工具:", toolName, updatedToolArgs);
                    
                    // 禁用按钮
                    $(this).prop('disabled', true)
                           .html('<i class="fa fa-spinner fa-spin" style="font-size: 12px;"></i> 执行中...')
                           .css({
                               'background': '#f3f4f6',
                               'color': '#6b7280',
                               'cursor': 'not-allowed'
                           });
                    
                    // 调用执行工具的API
                    executeJSONEditorTool(toolName, updatedToolArgs, $(this));
                    
                } catch (e) {
                    RED.notify("JSON格式错误: " + e.message, "error");
                    // 高亮错误行
                    document.getElementById(editorId).style.borderColor = '#dc3545';
                }
            });
            
            forceScrollToBottom();
            console.log("JSON编辑器添加完成");
        } else {
            console.error("找不到消息元素:", messageId);
        }
    }
    
    // 执行JSON编辑器的工具调用
    function executeJSONEditorTool(toolName, toolArgs, buttonElement) {
        console.log("执行JSON编辑器工具调用:", toolName, toolArgs);
        
        var nodeId = getSelectedConfigNodeId();
        if (!nodeId) {
            addMessageToChat("error", "❌ 未找到配置节点，请先创建并配置API密钥");
            buttonElement.prop('disabled', false).html('<i class="fa fa-check"></i> Apply');
            return;
        }
        
        var selectedFlow = null;
        try {
            var activeWorkspace = RED.workspaces.active();
            if (activeWorkspace) {
                selectedFlow = {
                    id: activeWorkspace,
                    label: RED.nodes.workspace(activeWorkspace).label
                };
            }
        } catch (error) {
            console.warn("获取当前流程失败:", error);
        }
        
        fetch('/ai-sidebar/execute-tool', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                toolName: toolName,
                toolArgs: toolArgs,
                nodeId: nodeId,
                selectedFlow: selectedFlow
            })
        })
        .then(response => response.json())
        .then(data => {
            console.log("工具执行结果:", data);
            
            if (data.success) {
                // 成功执行
                buttonElement.removeClass('execute-tool-btn')
                    .css({
                        'background': '#059669',
                        'cursor': 'default'
                    })
                    .html('<i class="fa fa-check"></i> 已应用')
                    .prop('disabled', true);
                
                // 显示成功消息
                addMessageToChat("system", "✅ 流程创建成功！");
                
                // 可选：刷新页面或更新流程列表
                if (typeof RED !== 'undefined' && RED.view) {
                    RED.view.redraw();
                }
            } else {
                // 执行失败
                buttonElement.prop('disabled', false)
                    .css('background', '#ef4444')
                    .text('执行失败');
                
                addMessageToChat("error", "❌ 工具执行失败: " + data.error);
                
                // 3秒后恢复按钮
                setTimeout(() => {
                    buttonElement.css('background', '#10b981').text('Apply');
                }, 3000);
            }
        })
        .catch(error => {
            console.error("工具执行错误:", error);
            buttonElement.prop('disabled', false)
                      .html('<i class="fa fa-exclamation-triangle" style="font-size: 12px;"></i> 重试')
                      .css({
                          'background': '#fef2f2',
                          'color': '#dc2626',
                          'border-color': '#fecaca'
                      });
            
            addMessageToChat("error", "❌ 网络错误: " + error.message);
        });
    }
    // 全局函数定义 - 必须在最开始
    function ensureAceEditorLoaded(callback) {
        if (typeof ace !== 'undefined') {
            callback();
            return;
        }
        
        // 如果ACE未加载，尝试从Node-RED加载
        if (RED && RED.editor && RED.editor.ace) {
            window.ace = RED.editor.ace;
            callback();
            return;
        }
        
        // 最后的降级方案
        console.warn("ACE编辑器未找到，将使用普通文本显示");
        callback();
    }

    function initializeJSONEditor(editorId, jsonContent) {
        try {
            // 验证JSON格式
            var parsedJSON;
            try {
                parsedJSON = JSON.parse(jsonContent);
            } catch (e) {
                console.error("JSON格式错误:", e);
                // 如果不是有效JSON，显示为普通文本
                document.getElementById(editorId).innerHTML = '<pre style="padding: 12px; margin: 0; background: #f8f9fa; color: #495057; white-space: pre-wrap; word-wrap: break-word;">' + jsonContent + '</pre>';
                return;
            }
            
            // 创建ACE编辑器
            var editor = ace.edit(editorId);
            editor.setTheme("ace/theme/textmate");
            editor.session.setMode("ace/mode/json");
            editor.setValue(JSON.stringify(parsedJSON, null, 2), -1);
            
            // 设置编辑器选项
            editor.setOptions({
                fontSize: 13,
                showPrintMargin: false,
                highlightActiveLine: true,
                showGutter: true,
                readOnly: false,
                maxLines: 20,
                minLines: 10,
                wrap: true,
                autoScrollEditorIntoView: true
            });
            
            // 存储编辑器实例以便后续操作
            window.jsonEditors = window.jsonEditors || {};
            window.jsonEditors[editorId] = editor;
            
            // 监听内容变化
            editor.session.on('change', function() {
                try {
                    var content = editor.getValue();
                    JSON.parse(content); // 验证JSON格式
                    // 如果JSON有效，移除错误样式
                    document.getElementById(editorId).style.borderColor = '#e9ecef';
                } catch (e) {
                    // 如果JSON无效，添加错误样式
                    document.getElementById(editorId).style.borderColor = '#dc3545';
                }
            });
            
        } catch (error) {
            console.error("初始化JSON编辑器失败:", error);
            // 降级显示为普通代码块
            document.getElementById(editorId).innerHTML = '<pre style="padding: 12px; margin: 0; background: #f8f9fa; color: #495057; white-space: pre-wrap; word-wrap: break-word;">' + jsonContent + '</pre>';
        }
    }

    // 显示场景选择菜单
    function showScenarioMenu(e) {
        console.log('=== showScenarioMenu 详细调试信息 ===');
        console.log('1. 事件对象:', e);
        console.log('2. 事件类型:', e ? e.type : 'undefined');
        console.log('3. 事件目标:', e ? e.target : 'undefined');
        console.log('4. ScenarioManager对象:', ScenarioManager);
        console.log('5. ScenarioManager.isLoaded:', ScenarioManager.isLoaded);
        console.log('6. ScenarioManager.scenarios:', ScenarioManager.scenarios);
        console.log('7. 场景数量:', Object.keys(ScenarioManager.scenarios || {}).length);
        console.log('8. 当前场景:', ScenarioManager.currentScenario);
        console.log('9. jQuery版本:', $.fn.jquery);
        console.log('10. #augment-chat-container元素:', $('#augment-chat-container').length);
        
        // 移除已存在的菜单
        $('.scenario-menu').remove();
        console.log('11. 已移除现有菜单');
        
        // 添加详细的调试信息
        console.log('showScenarioMenu调用 - ScenarioManager状态:', {
            isLoaded: ScenarioManager.isLoaded,
            scenariosKeys: Object.keys(ScenarioManager.scenarios),
            scenariosLength: Object.keys(ScenarioManager.scenarios).length,
            currentScenario: ScenarioManager.currentScenario
        });
        
        // 检查场景数据是否已加载
        if (!ScenarioManager.isLoaded || Object.keys(ScenarioManager.scenarios).length === 0) {
            console.warn('场景数据未加载，无法显示菜单');
            
            // 尝试重新加载场景数据
            console.log('尝试重新加载场景数据...');
            ScenarioManager.loadScenarios().then(() => {
                console.log('场景数据重新加载成功，重新调用showScenarioMenu');
                showScenarioMenu(e);
            }).catch(error => {
                console.error('重新加载场景数据失败:', error);
                // 显示错误提示
                addMessageToChat('error', '❌ 场景数据加载失败，请刷新页面重试');
            });
            return;
        }
        
        // 场景图标映射
        var scenarioIcons = {
            'learning': '🎓',
            'solution': '💡', 
            'integration': '🔌',
            'development': '💻',
            'configuration': '⚙️',
            'management': '🖥️',
            'general': '💬'
        };
        
        // 动态生成场景选项
        var scenarioOptions = '';
        // 获取实际的场景数据
        var scenarios = ScenarioManager.scenarios.scenarios || ScenarioManager.scenarios;
        console.log('实际场景数据:', scenarios);
        
        Object.keys(scenarios).forEach(function(scenarioId) {
            var scenario = scenarios[scenarioId];
            var icon = scenarioIcons[scenarioId] || '📋';
            console.log('处理场景:', scenarioId, scenario);
            
            scenarioOptions += `
                <div class="scenario-option" data-scenario="${scenarioId}" style="
                    padding: 6px 12px;
                    cursor: pointer;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                    color: #374151;
                    transition: background-color 0.1s;
                " onmouseover="this.style.backgroundColor='#f3f4f6'" onmouseout="this.style.backgroundColor='transparent'">
                    <span style="font-size: 14px;">${icon}</span>
                    <span>${scenario.name}</span>
                </div>
            `;
        });
        
        // 创建场景选择菜单
        console.log('12. 开始创建菜单HTML');
        console.log('13. scenarioOptions内容:', scenarioOptions);
        
        var menuHtml = `
            <div class="scenario-menu" style="
                position: absolute;
                bottom: 60px;
                right: 16px;
                background: white;
                border: 1px solid #d1d5db;
                border-radius: 4px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                z-index: 1000;
                min-width: 160px;
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                font-size: 13px;
                padding: 4px 0;
            ">
                ${scenarioOptions}
            </div>
        `;
        
        console.log('14. 菜单HTML已创建，长度:', menuHtml.length);
        console.log('15. 菜单HTML内容:', menuHtml.substring(0, 200) + '...');
        
        // 添加菜单到页面
        console.log('16. 准备添加菜单到页面');
        $('#augment-chat-container').append(menuHtml);
        console.log('17. 菜单已添加到页面');
        console.log('18. 页面中的.scenario-menu元素数量:', $('.scenario-menu').length);
        console.log('19. .scenario-menu元素是否可见:', $('.scenario-menu').is(':visible'));
        
        // 绑定场景选择事件
        console.log('20. 开始绑定场景选择事件');
        console.log('21. .scenario-option元素数量:', $('.scenario-option').length);
        
        $('.scenario-option').on('click', function() {
            console.log('22. 场景选项被点击');
            var scenarioId = $(this).data('scenario');
            console.log('23. 选择的场景ID:', scenarioId);
            ScenarioManager.switchScenario(scenarioId);
            $('.scenario-menu').remove();
        });
        
        // 点击其他地方关闭菜单
        console.log('24. 绑定文档点击事件');
        $(document).on('click.scenario-menu', function(e) {
            if (!$(e.target).closest('.scenario-menu, #augment-at-mention').length) {
                console.log('25. 点击其他地方，关闭菜单');
                $('.scenario-menu').remove();
                $(document).off('click.scenario-menu');
            }
        });
        
        console.log('26. showScenarioMenu函数执行完成');
    }

    // 增强代码块显示 - 为JSON代码块添加工具栏
    function enhanceCodeBlocks(messageElement) {
        console.log('开始增强代码块显示');
        
        messageElement.find('pre code').each(function(index) {
            var $code = $(this);
            var $pre = $code.parent();
            var codeText = $code.text().trim();
            
            console.log('检查代码块', index, '内容长度:', codeText.length, '前100字符:', codeText.substring(0, 100));
            
            // 检查是否已经处理过
            if ($pre.hasClass('enhanced-code-block')) {
                console.log('代码块已处理，跳过');
                return;
            }
            
            // 检查是否是JSON代码块 - 支持对象和数组格式
            var isJsonFormat = (codeText.startsWith('{') && codeText.endsWith('}')) || 
                              (codeText.startsWith('[') && codeText.endsWith(']'));
            
            if (isJsonFormat) {
                console.log('检测到JSON代码块，尝试解析...');
                
                try {
                    var parsedJson = JSON.parse(codeText);
                    console.log('JSON解析成功:', parsedJson);
                    
                    // 检查是否是流程配置JSON
                    var isFlowConfig = false;
                    
                    if (Array.isArray(parsedJson)) {
                        // 数组格式：检查是否包含Node-RED节点
                        isFlowConfig = parsedJson.some(item => 
                            item && typeof item === 'object' && 
                            (item.type === 'tab' || item.type || item.id || item.nodes)
                        );
                    } else if (typeof parsedJson === 'object' && parsedJson !== null) {
                        // 对象格式：检查是否是流程配置
                        isFlowConfig = parsedJson.nodes || parsedJson.label || parsedJson.id || 
                                      parsedJson.type || parsedJson.flows;
                    }
                    
                    console.log('是否为流程配置:', isFlowConfig);
                    
                    if (isFlowConfig) {
                        console.log('为JSON代码块添加工具栏');
                        
                        // 标记已处理
                        $pre.addClass('enhanced-code-block');
                        
                        // 生成唯一ID
                        var blockId = 'code-block-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9);
                        $pre.attr('id', blockId);
                        
                        // 获取文件名
                        var fileName = 'flow-config';
                        if (Array.isArray(parsedJson)) {
                            var tabNode = parsedJson.find(item => item.type === 'tab');
                            if (tabNode && tabNode.label) {
                                fileName = tabNode.label;
                            }
                        } else if (parsedJson.label || parsedJson.name) {
                            fileName = parsedJson.label || parsedJson.name;
                        }
                        
                        // 创建工具栏HTML
                        var toolbarHtml = `
                            <div id="code-toolbar-${blockId}" class="code-toolbar" style="
                                height: 32px;
                                background: #f8f9fa;
                                border-bottom: 1px solid #e9ecef;
                                display: flex;
                                align-items: center;
                                justify-content: space-between;
                                padding: 0 12px;
                                font-size: 12px;
                                border-radius: 6px 6px 0 0;
                                box-sizing: border-box;
                                width: 100%;
                                flex-shrink: 0;
                                position: absolute;
                                top: 0;
                                left: 0;
                                right: 0;
                            ">
                                <!-- 左侧：折叠按钮 + 文件标题 -->
                                <div style="display: flex; align-items: center; gap: 8px; min-width: 0; flex: 1;">
                                    <button class="code-collapse-btn" data-block-id="${blockId}" style="
                                        background: none;
                                        border: none;
                                        color: #6c757d;
                                        cursor: pointer;
                                        padding: 2px 4px;
                                        border-radius: 3px;
                                        display: flex;
                                        align-items: center;
                                        font-size: 10px;
                                        line-height: 1;
                                        flex-shrink: 0;
                                    " title="折叠/展开">
                                        <i class="fa fa-chevron-down"></i>
                                    </button>
                                    <span style="
                                        color: #495057; 
                                        font-weight: 500; 
                                        font-size: 11px;
                                        white-space: nowrap;
                                        overflow: hidden;
                                        text-overflow: ellipsis;
                                        min-width: 0;
                                    ">
                                        <i class="fa fa-file-code-o" style="margin-right: 4px; color: #28a745; font-size: 10px;"></i>
                                        ${fileName}.json
                                    </span>
                                </div>
                                
                                <!-- 右侧：操作按钮组 -->
                                <div style="display: flex; align-items: center; gap: 6px; position: relative; flex-shrink: 0;">
                                    <button class="code-more-btn" 
                                            data-block-id="${blockId}"
                                            data-json-content='${JSON.stringify(parsedJson).replace(/'/g, "&#39;")}'
                                            style="
                                                background: #28a745;
                                                border: none;
                                                border-radius: 4px;
                                                color: white;
                                                padding: 4px 8px;
                                                font-size: 11px;
                                                cursor: pointer;
                                                display: flex;
                                                align-items: center;
                                                gap: 4px;
                                                transition: all 0.2s;
                                                font-weight: 500;
                                                line-height: 1;
                                                white-space: nowrap;
                                                position: relative;
                                            "
                                            onmouseover="this.style.background='#218838'"
                                            onmouseout="this.style.background='#28a745'"
                                            title="创建流程">
                                        <i class="fa fa-check" style="font-size: 9px;"></i>
                                        Apply
                                    </button>
                                </div>
                            </div>
                        `;
                        // 修改pre样式以容纳工具栏
                        $pre.css({
                            'position': 'relative',
                            'margin': '16px 0',
                            'border': '1px solid #e9ecef',
                            'border-radius': '6px',
                            'background': '#ffffff',
                            'padding-top': '32px',
                            'overflow': 'hidden',
                            'width': '100%',
                            'box-sizing': 'border-box'
                        });
                        
                        // 修改code样式
                        $code.css({
                            'display': 'block',
                            'padding': '16px',
                            'background': 'transparent',
                            'border': 'none',
                            'border-radius': '0 0 6px 6px',
                            'max-height': '400px',
                            'overflow-x': 'hidden',
                            'overflow-y': 'auto',
                            'margin': '0',
                            'width': '100%',
                            'box-sizing': 'border-box',
                            'white-space': 'pre',
                            'word-wrap': 'normal'
                        });
                        
                        // 添加工具栏到pre元素
                        $pre.prepend(toolbarHtml);
                        
                        console.log('JSON代码块工具栏添加完成:', blockId);
                    } else {
                        console.log('不是流程配置JSON，跳过处理');
                    }
                } catch (e) {
                    console.log('JSON解析失败，跳过处理:', e.message);
                }
            } else {
                console.log('不是JSON代码块，跳过处理');
            }
        });
    }
    
    function copyEditorContent(editorId) {
        try {
            var editor = window.jsonEditors && window.jsonEditors[editorId];
            var content;
            
          
            if (editor) {
                content = editor.getValue();
            } else {
                // 降级方案：从DOM获取内容
                var element = document.getElementById(editorId);
                content = element.textContent || element.innerText;
            }
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(content).then(function() {
                    RED.notify("内容已复制到剪贴板", "success");
                }).catch(function(err) {
                    console.error('复制失败:', err);
                    fallbackCopyTextToClipboard(content);
                });
            } else {
                fallbackCopyTextToClipboard(content);
            }
        } catch (error) {
            console.error("复制编辑器内容时出错:", error);
            RED.notify("复制失败: " + error.message, "error");
        }
    }

    function applyEditorContent(editorId) {
        try {
            var editor = window.jsonEditors && window.jsonEditors[editorId];
            if (!editor) {
                RED.notify("编辑器未找到", "error");
                return;
            }
            
            var content = editor.getValue();
            
            // 验证JSON格式
            try {
                JSON.parse(content);
                RED.notify("JSON格式有效，内容已应用", "success");
                
                // 这里可以添加实际的应用逻辑，比如：
                // - 保存到配置文件
                // - 更新Node-RED配置
                // - 发送到后端API等
                
            } catch (e) {
                RED.notify("JSON格式错误: " + e.message, "error");
            }
            
        } catch (error) {
            console.error("应用编辑器内容时出错:", error);
            RED.notify("应用失败: " + error.message, "error");
        }
    }

    function fallbackCopyTextToClipboard(text) {
        var textArea = document.createElement("textarea");
        textArea.value = text;
        
        // 避免滚动到底部
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";
        
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            var successful = document.execCommand('copy');
            if (successful) {
                RED.notify("内容已复制到剪贴板", "success");
            } else {
                RED.notify("复制失败", "error");
            }
        } catch (err) {
            console.error('降级复制方案失败:', err);
            RED.notify("复制失败", "error");
        }
        
        document.body.removeChild(textArea);
    }
    // Render markdown content
    function renderMarkdown(content) {
        if (!content || typeof content !== 'string') {
            return content || '';
        }
        
        console.log('开始渲染Markdown，内容长度:', content.length);
        
        // 预处理：处理Node-RED流程JSON中的function节点代码
        content = preprocessNodeRedFunctionCode(content);
        
        // 预处理：处理ACTION_TYPE标记
        content = preprocessActionType(content);
        
        // Check if showdown is available
        if (typeof showdown !== 'undefined') {
            try {
                var converter = new showdown.Converter({
                    tables: true,
                    strikethrough: true,
                    tasklists: true,
                    ghCodeBlocks: true,
                    smoothLivePreview: true,
                    simplifiedAutoLink: true,
                    excludeTrailingPunctuationFromURLs: true,
                    literalMidWordUnderscores: true,
                    simpleLineBreaks: true,
                    parseImgDimensions: true,
                    headerLevelStart: 1,
                    backslashEscapesHTMLTags: true
                });
                var result = converter.makeHtml(content);
                
                // 后处理：在代码块中恢复按钮HTML
                result = result.replace(/<code([^>]*)>([\s\S]*?)<\/code>/g, function(match, attrs, codeContent) {
                    // 在代码块中查找转义的按钮HTML并恢复
                    var processedContent = codeContent
                        .replace(/&lt;button class=&quot;code-view-btn&quot;[\s\S]*?&gt;查看代码&lt;\/button&gt;/g, 
                            function(buttonMatch) {
                                // 完全解码按钮HTML
                                var decodedButton = buttonMatch
                                    .replace(/&lt;/g, '<')
                                    .replace(/&gt;/g, '>')
                                    .replace(/&quot;/g, '"')
                                    .replace(/&amp;/g, '&')
                                    .replace(/&#39;/g, "'");
                                
                                console.log('恢复按钮HTML:', decodedButton);
                                return decodedButton;
                            });
                    
                    return '<code' + attrs + '>' + processedContent + '</code>';
                });
                
                console.log('Showdown渲染成功，结果长度:', result.length);
                console.log('Showdown渲染结果预览:', result.substring(0, 300));
                return result;
            } catch (error) {
                console.error('Showdown渲染失败:', error);
            }
        } else {
            console.log('Showdown未加载，使用降级方案');
        }
        
        // Enhanced fallback with better regex patterns
        console.log('使用降级Markdown渲染');
        
        // 首先处理换行符，确保正确的段落分隔
        var lines = content.split('\n');
        var processedLines = [];
        var inCodeBlock = false;
        var codeBlockContent = [];
        var codeBlockLang = '';
        
        for (var i = 0; i < lines.length; i++) {
            var line = lines[i];
            
            // 检查代码块开始/结束
            if (line.match(/^```(\w+)?/)) {
                if (!inCodeBlock) {
                    // 开始代码块
                    inCodeBlock = true;
                    codeBlockLang = line.match(/^```(\w+)?/)[1] || '';
                    codeBlockContent = [];
                } else {
                    // 结束代码块
                    inCodeBlock = false;
                    var escapedCode = codeBlockContent.join('\n')
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                    processedLines.push('<pre><code class="' + codeBlockLang + '">' + escapedCode + '</code></pre>');
                    codeBlockContent = [];
                    codeBlockLang = '';
                }
                continue;
            }
            
            if (inCodeBlock) {
                codeBlockContent.push(line);
                continue;
            }
            
            // 处理标题
            if (line.match(/^#{1,6}\s/)) {
                var headerLevel = line.match(/^(#{1,6})/)[1].length;
                var headerText = line.replace(/^#{1,6}\s/, '');
                processedLines.push('<h' + headerLevel + '>' + headerText + '</h' + headerLevel + '>');
                continue;
            }
            
            // 处理列表项
            if (line.match(/^\s*[\*\-\+]\s/)) {
                var listItem = line.replace(/^\s*[\*\-\+]\s/, '');
                processedLines.push('<li>' + listItem + '</li>');
                continue;
            }
            
            // 处理空行
            if (line.trim() === '') {
                processedLines.push('</p><p>');
                continue;
            }
            
            // 普通文本行
            processedLines.push(line);
        }
        
        // 合并处理后的行
        var result = processedLines.join('\n');
        
        // 处理行内格式
        result = result
            // 行内代码
            .replace(/`([^`\n]+)`/g, '<code style="background: #f1f5f9; padding: 2px 4px; border-radius: 3px; font-family: monospace; font-size: 0.9em;">$1</code>')
            // 粗体
            .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
            // 斜体
            .replace(/\*(.*?)\*/g, '<em>$1</em>')
            // 处理换行
            .replace(/\n/g, '<br>');
        
        // 包装列表项
        result = result.replace(/(<li>.*?<\/li>(?:<br><li>.*?<\/li>)*)/g, '<ul>$1</ul>');
        result = result.replace(/<br>(<li>)/g, '$1');
        result = result.replace(/(<\/li>)<br>/g, '$1');
        
        // 包装段落
        if (result && !result.startsWith('<')) {
            result = '<p>' + result + '</p>';
        }
        
        // 清理多余的段落标签
        result = result.replace(/<\/p><p><\/p><p>/g, '</p><p>');
        result = result.replace(/<p><\/p>/g, '');
        
        console.log('降级渲染完成，结果长度:', result.length);
        console.log('降级渲染结果预览:', result.substring(0, 300));
        return result;
    }
// 主要的代码逻辑
(function() {
    var globalAutoLayoutConfigNode = null;
  
    var dothisOneTimePlease = () => {
        RED.events.off('runtime-state', dothisOneTimePlease);

        // Load markdown libraries for rendering and wait for completion
        loadMarkdownLibraries().then(() => {
            console.log('Markdown库加载完成，可以开始渲染');
            addMarkdownStyles();
        });

        // Load sidebar content template
        var content = $($('script[type="text/x-red"][data-template-name="make_iot_smart_sidebar"]').i18n().html());
       
        // Add AI assistant tab to right sidebar panel
        RED.sidebar.addTab({
            id: "ai-sidebar",
            label: "MIS",
            name: "AI助手",
            content: content,
            closeable: true,
            disableOnEdit: false,
            iconClass: "fa fa-comment",
            onshow: function() {
                console.log('侧边栏显示');
            }
        });
        
        // 立即初始化场景管理器，不依赖侧边栏显示
        console.log('开始初始化场景管理器...');
        
        // 延迟初始化以确保DOM元素已加载
        setTimeout(() => {
                    // 更新上下文信息
                    updateCurrentFlowName();
                    updateSelectedNodeInfo();
                    
                    // 初始化场景管理器，并在加载完成后显示欢迎消息
                    ScenarioManager.loadScenarios().then(() => {
                        // 绑定场景选择事件
                        $("#scenario-selector").on("change", function() {
                            var selectedScenario = $(this).val();
                            ScenarioManager.switchScenario(selectedScenario);
                        });
                        
                        // 绑定场景菜单按钮事件 - 在场景数据加载完成后
                        console.log('开始绑定场景菜单按钮事件');
                        console.log('按钮元素存在:', $("#augment-at-mention").length > 0);
                        
                        $("#augment-at-mention").off('click').on("click", function(e) {
                            e.preventDefault();
                            console.log('=== 场景菜单按钮被点击 ===');
                            console.log('事件对象:', e);
                            showScenarioMenu(e);
                        });
                        
                        console.log('场景菜单按钮事件绑定完成');
                        
                        // 移除了自动触发点击测试的代码，避免页面加载时自动弹出场景菜单
                        
                        // 初始化默认场景
                        ScenarioManager.updateUI();
                        
                        // 移除欢迎对话框显示
                        
                        // 添加欢迎消息
                        var currentScenario = ScenarioManager.scenarios[ScenarioManager.currentScenario];
                        var welcomeMsg = `👋 欢迎使用 Make IoT Smart AI助手！

🎯 **当前场景**: ${currentScenario ? currentScenario.name : '学习'}

请选择合适的场景并开始对话：
• 🎓 **学习** - 了解Node-RED概念和节点
• 💡 **方案** - 获取IoT解决方案建议  
• 🔌 **集成** - 集成协议和系统
• 💻 **开发** - 优化和开发流程
• ⚙️ **配置** - 配置Node-RED环境
• 🖥️ **管理** - 管理和部署应用`;
                        
                        addMessageToChat('assistant', welcomeMsg);
                    }).catch(error => {
                        console.error('加载场景失败:', error);
                        // 使用默认场景数据作为降级方案
                        ScenarioManager.scenarios = {
                            learning: {
                                name: '学习',
                                description: '学习Node-RED节点和流程概念',
                                prompt: []
                            }
                        };
                        ScenarioManager.isLoaded = true;
                        ScenarioManager.updateUI();
                        
                        // 显示降级欢迎消息
                        var welcomeMsg = `👋 欢迎使用 Make IoT Smart AI助手！

🎯 **当前场景**: 学习

请开始对话，我将帮助您了解Node-RED的使用。`;
                        addMessageToChat('assistant', welcomeMsg);
                    });
                }, 100);

        // 配置按钮事件处理
        $("#show-config-node-button").on("click", function() {
            console.log("点击配置按钮");
            
            try {
                var apiConfigNodes = [];
                RED.nodes.eachConfig(function(configNode) {
                    if (configNode.type === 'api-config') {
                        apiConfigNodes.push(configNode);
                    }
                });
                
                if (apiConfigNodes.length > 0) {
                    console.log("找到api-config节点，打开编辑界面");
                    RED.editor.editConfig("", "api-config", apiConfigNodes[0].id);
                } else {
                    console.log("没有找到api-config节点，直接打开编辑对话框");
                    RED.editor.editConfig("", "api-config");
                }
            } catch (error) {
                console.error("处理过程中发生错误:", error);
                RED.notify("显示配置节点时出错: " + error.message, "error");
            }
        });
        
        // 初始化AI助手UI
        setupAIAssistant();
        
        // 初始化当前flow名称显示
        updateCurrentFlowName();
        
        // 初始化当前选中节点信息
        updateSelectedNodeInfo();
        
        // 初始化聊天历史下拉菜单
        initChatHistoryDropdown();
        
        // 监听workspace选择变化
        RED.events.on('workspace:change', updateCurrentFlowName);
        
        // 监听节点选择变化
        RED.events.on('view:selection-changed', updateSelectedNodeInfo);
    };
    RED.events.on('runtime-state', dothisOneTimePlease );
})();


</script>

<script type="text/x-red" data-template-name="make_iot_smart_sidebar">
    <div class="red-ui-sidebar-info">
        <div class="red-ui-sidebar-header red-ui-info-toolbar" style="display: flex; align-items: center; gap: 8px;">
            <span class="button-group"><a id="show-config-node-button" class="red-ui-button red-ui-button-small selected" href="#">
                <i class="fa fa-cog"></i></a></span>
            <div class="chat-history-dropdown-container" style="position: relative; flex: 1;">
                <button id="chat-history-dropdown-btn" class="red-ui-button red-ui-button-small" style="
                    width: 100%;
                    display: flex;
                    align-items: center;
                    justify-content: space-between;
                    padding: 4px 8px;
                    background: #f8f9fa;
                    border: 1px solid #d1d5db;
                    border-radius: 4px;
                    font-size: 12px;
                    color: #6b7280;
                    cursor: pointer;
                ">
                    <span style="display: flex; align-items: center; gap: 6px;">
                        <i class="fa fa-history" style="font-size: 11px;"></i>
                        <span id="chat-history-label">聊天历史</span>
                    </span>
                    <i class="fa fa-chevron-down" style="font-size: 10px;"></i>
                </button>
                <div id="chat-history-dropdown-menu" class="chat-history-menu" style="
                    display: none;
                    position: absolute;
                    top: 100%;
                    left: 0;
                    right: 0;
                    background: white;
                    border: 1px solid #d1d5db;
                    border-radius: 6px;
                    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
                    z-index: 1000;
                    max-height: 300px;
                    overflow-y: auto;
                    margin-top: 2px;
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    min-width: 200px;
                    max-width: 350px;
                    width: auto;
                    box-sizing: border-box;
                ">
                    <div class="chat-history-empty" style="
                        padding: 16px;
                        text-align: center;
                        color: #9ca3af;
                        font-size: 12px;
                    ">暂无聊天历史</div>
                </div>
            </div>
        </div>

        <div class="red-ui-debug-content red-ui-debug-content-list" id="augment-chat-messages" style="
            position: absolute; 
            top: 40px; 
            bottom: 130px; 
            left: 0; 
            right: 0; 
            overflow-y: auto; 
            padding: 20px 16px;
            background: #fafafa;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        ">
            <!-- 聊天消息将在这里显示 -->
        </div>

        <!-- Augment工具UI -->
        <div id="augment-chat-container" class="augment-chat-container" style="
            position: absolute; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: #ffffff; 
            border-top: 1px solid #e5e7eb;
            padding: 5px; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        ">
            <!-- 上下文信息栏 -->
            <div class="augment-chat-context" style="
                font-size: 12px; 
                color: #6b7280; 
                padding: 12px 16px;
                background: #f9fafb;
                border-radius: 8px;
                border: 1px solid #f3f4f6;
            ">
                <div style="display: flex; align-items: center; flex-wrap: wrap; gap: 12px;">
                    <span style="display: flex; align-items: center;">
                        <i class="fa fa-sitemap" style="margin-right: 6px; color: #374151;"></i> 
                        <span id="current-flow-name" style="font-weight: 500; color: #1f2937;">未选择流程</span>
                    </span>
                    <span style="color: #d1d5db;">></span>
                    <span style="display: flex; align-items: center;">
                        <i class="fa fa-cube" style="margin-right: 6px; color: #374151;"></i>
                        <span id="current-selected-node" style="font-weight: 500; color: #1f2937;">未选择节点</span>
                    </span>
                    <span id="selected-node-type-container" style="display: none;">
                        <span style="color: #d1d5db;">|</span>
                        <span style="color: #6b7280;">类型: <span id="current-selected-node-type" style="font-weight: 500; color: #1f2937;"></span></span>
                    </span>
                </div>
            </div>
            
            <!-- 输入框区域 -->
            <div class="augment-chat-input-container" style="
                border: 1px solid #d1d5db;
                border-radius: 12px;
                background: #ffffff;
                position: relative;
                transition: border-color 0.2s, box-shadow 0.2s;
            " onfocus="this.style.borderColor='#3b82f6'; this.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'" onblur="this.style.borderColor='#d1d5db'; this.style.boxShadow='none'">
                <textarea id="augment-chat-input" placeholder="Ask or instruct Augment" 
                          style="
                              width: 100%; 
                              min-height: 80px; 
                              padding: 16px 60px 16px 16px; 
                              border: none;
                              border-radius: 12px; 
                              resize: none; 
                              outline: none; 
                              font-family: inherit; 
                              font-size: 14px; 
                              background: transparent; 
                              color: #374151; 
                              overflow: hidden;
                              line-height: 1.5;
                          "
                          rows="3"
                          onfocus="this.parentElement.style.borderColor='#3b82f6'; this.parentElement.style.boxShadow='0 0 0 3px rgba(59, 130, 246, 0.1)'"
                          onblur="this.parentElement.style.borderColor='#d1d5db'; this.parentElement.style.boxShadow='none'"></textarea>
                
                <!-- 工具栏 -->
                <div style="
                    position: absolute;
                    bottom: 12px;
                    right: 12px;
                    display: flex;
                    align-items: center;
                    gap: 8px;
                ">
                    <!-- 工具按钮 -->
                    <div style="display: flex; gap: 4px;">
                        <button id="augment-attach-file" style="
                            background: none;
                            border: none;
                            color: #6b7280;
                            cursor: pointer;
                            padding: 6px;
                            border-radius: 6px;
                            font-size: 14px;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        " onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">
                            <i class="fa fa-paperclip"></i>
                        </button>
                        <button id="augment-at-mention" style="
                            background: none;
                            border: none;
                            color: #6b7280;
                            cursor: pointer;
                            padding: 6px;
                            border-radius: 6px;
                            font-size: 14px;
                            transition: all 0.2s;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                        " onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">
                            <i class="fa fa-at"></i>
                            <span style="
                                font-size: 11px;
                                color: #6b7280;
                                display: flex;
                                align-items: center;
                                padding: 0 4px;
                                line-height: 1;
                            ">
                                场景：<span id="current-scenario-name" style="font-weight: 500;">通用</span>
                            </span>
                        </button>
                    
                    </div>
                    
                    <!-- 发送按钮 -->
                    <button id="augment-send" style="
                        background: #3b82f6;
                        border: none;
                        border-radius: 8px;
                        color: white;
                        padding: 8px 16px;
                        font-size: 13px;
                        font-weight: 500;
                        cursor: pointer;
                        transition: background-color 0.2s;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                    " onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                        <i class="fa fa-paper-plane"></i>
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>
</script>
