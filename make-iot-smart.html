<!--
Copyright (c) 2024 Zheng He

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.
-->
<script type="text/javascript">
(function ($) {
    RED.nodes.registerType('make-iot-smart', {
        category: 'config',
        defaults: {
            name: { value: "" },
            apiConfig: { value: "", type: "api-config", required: true },
            algorithm: { value: "dagre_lr" },
            settings: { value: {} },
            valid: { value: true }
        },
        inputs: 0,
        outputs: 0,
        icon: "font-awesome/fa-magic",
        paletteLabel: function() {
            return this._("make-iot-smart.paletteLabel") || "AI Assistant";
        },
        label: function () {
            return this.name || this._("make-iot-smart.label.defaultName") || "AI Assistant";
        },
        oneditprepare: function() {
            // 自动隐藏节点
            var node = this;
            setTimeout(function() {
                if (node.z && RED.view) {
                    // 将节点移到画布外不可见区域
                    node.x = -1000;
                    node.y = -1000;
                    RED.view.redraw();
                }
            }, 100);
        }
    });
})(jQuery);
</script>

<!-- AI助手节点的HTML模板 -->
<script type="text/x-red" data-template-name="make-iot-smart">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="make-iot-smart.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]make-iot-smart.placeholder.name">
    </div>
    <div class="form-row">
        <label for="node-input-apiConfig"><i class="fa fa-cog"></i> <span data-i18n="make-iot-smart.label.apiConfig"></span></label>
        <input type="text" id="node-input-apiConfig">
    </div>
    <div class="form-tips">
        <p data-i18n="make-iot-smart.tips.autoHide"></p>
    </div>
</script>

<script type="text/x-red" data-help-name="make-iot-smart">
    <p>AI-powered smart IoT assistant that can understand natural language commands and interact with IoT devices.</p>
    
    <h3>Details</h3>
    <p>This node provides AI-driven assistance for IoT device management and automation. It can process natural language input, understand device states, and execute commands through connected APIs.</p>
    
    <h4>Features</h4>
    <p>Key features include natural language processing, device state monitoring, automated responses, and integration with multiple AI providers.</p>
    
    <h4>AI Sidebar</h4>
    <p>The AI sidebar provides an interactive interface for communicating with the AI assistant directly from the Node-RED editor.</p>
    
    <h4>Auto Hide</h4>
    <p>The auto-hide feature automatically minimizes the AI sidebar when not actively in use, keeping the workspace clean.</p>
    
    <h3>Configuration</h3>
    <p>Configure the node by selecting an API configuration, setting response parameters, and defining device interaction rules.</p>
    
    <h3>Usage</h3>
    <p>1. Connect an API configuration node<br/>
    2. Deploy the flow<br/>
    3. Use the AI sidebar to interact with the assistant<br/>
    4. The node will process messages and provide intelligent responses</p>
    
    <h3>References</h3>
    <ul>
        <li><a href="https://github.com/your-repo/node-red-make-iot-smart" target="_blank">GitHub Repository</a></li>
        <li><a href="https://www.npmjs.com/package/@jimmyfreecoding/node-red-make-iot-smart" target="_blank">NPM Package</a></li>
        <li><a href="https://github.com/your-repo/node-red-make-iot-smart/blob/main/README.md" target="_blank">Documentation</a></li>
    </ul>
</script>

<!-- API配置节点的HTML模板 -->
<script type="text/x-red" data-template-name="api-config">
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-tag"></i> <span data-i18n="api-config.label.name"></span></label>
        <input type="text" id="node-config-input-name" data-i18n="[placeholder]api-config.placeholder.name">
    </div>
    <div class="form-row">
        <label for="node-config-input-provider"><i class="fa fa-server"></i> <span data-i18n="api-config.label.provider"></span></label>
        <select id="node-config-input-provider">
            <option value="openai">OpenAI</option>
            <option value="deepseek">DeepSeek</option>
            <option value="anthropic">Anthropic</option>
            <option value="google">Google</option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-config-input-apiKey"><i class="fa fa-key"></i> <span data-i18n="api-config.label.apiKey"></span></label>
        <input type="password" id="node-config-input-apiKey" data-i18n="[placeholder]api-config.placeholder.apiKey">
        <div class="form-tips">
            <p data-i18n="api-config.tips.apiKey"></p>
        </div>
    </div>
    <div class="form-row">
        <label for="node-config-input-model"><i class="fa fa-brain"></i> <span data-i18n="api-config.label.model"></span></label>
        <select id="node-config-input-model">
            <!-- 动态填充 -->
        </select>
    </div>
    <div class="form-row" id="model-capabilities" style="display: none;">
        <div class="form-tips">
                            <div><i class="fa fa-times" style="color:red;"></i> <span data-i18n="api-config.tips.capabilities.noImage"></span></div>
                            <div><i class="fa fa-times" style="color:red;"></i> <span data-i18n="api-config.tips.capabilities.noBrowser"></span></div>
                            <div><i class="fa fa-check" style="color:green;"></i> <span data-i18n="api-config.tips.capabilities.promptCache"></span></div>
                            <div><span data-i18n="api-config.tips.capabilities.maxInput"></span></div>
                            <div><span data-i18n="api-config.tips.capabilities.cacheWritePrice"></span></div>
                            <div><span data-i18n="api-config.tips.capabilities.cacheReadPrice"></span></div>
                            <div><span data-i18n="api-config.tips.capabilities.outputPrice"></span></div>
                        </div>
    </div>
    <div class="form-row" style="display: none;">
        <label for="node-config-input-useDifferentModels">
            <input type="checkbox" id="node-config-input-useDifferentModels" style="width:auto;">
            <span data-i18n="api-config.label.useDifferentModels"></span>
        </label>
    </div>
    <div class="form-row" style="display: none;">
        <div class="form-tips"><span data-i18n="api-config.tips.differentModels"></span></div>
    </div>
    <div class="form-row">
        <label for="node-config-input-maxTokens"><i class="fa fa-sort-numeric-asc"></i> <span data-i18n="api-config.label.maxTokens"></span></label>
        <input type="number" id="node-config-input-maxTokens" min="100" max="8000" step="100">
    </div>
    

</script>

<!-- API配置节点的JavaScript注册 -->
<script type="text/javascript">
    RED.nodes.registerType('api-config', {
        category: 'config',
        defaults: {
            name: { value: "" },
            provider: { value: "openai", required: true },
            model: { value: "gpt-4o-mini", required: true },
            useDifferentModels: { value: false },
            planningModel: { value: "" },
            executionModel: { value: "" },
            temperature: { value: 0.1, validate: RED.validators.number() },
            maxTokens: { value: 2000, validate: RED.validators.number() },

        },
        credentials: {
            apiKey: { type: "password", required: true }
        },
        label: function() {
            return this.name || `${this.provider} (${this.model})`;
        },

        oneditprepare: function() {
            var node = this;
            
            // 存储提供商和模型数据
            var providersData = {};
            
            // 从后端获取LLM提供商和模型列表
            function loadProvidersAndModels() {
                return $.ajax({
                    url: '/ai-sidebar/llm-providers',
                    method: 'GET',
                    dataType: 'json'
                }).done(function(response) {
                    if (response && response.providers) {
                        providersData = response.providers;
                        // console.log('加载的提供商数据:', providersData);
                        
                        // 更新提供商选择器
                        updateProviderOptions();
                        
                        // 初始化模型选项
                        updateModelOptions($('#node-config-input-model'), node.provider);
                        updateModelOptions($('#node-config-input-planningModel'), node.provider);
                        updateModelOptions($('#node-config-input-executionModel'), node.provider);
                    }
                }).fail(function(xhr, status, error) {
                    // console.error('加载LLM提供商列表失败:', error);
                    // 使用默认的硬编码数据作为后备
                    providersData = {
                        openai: {
                            name: 'OpenAI',
                            models: [
                                { value: 'gpt-4o', label: 'GPT-4o' },
                                { value: 'gpt-4o-mini', label: 'GPT-4o Mini' },
                                { value: 'gpt-4-turbo', label: 'GPT-4 Turbo' },
                                { value: 'gpt-3.5-turbo', label: 'GPT-3.5 Turbo' }
                            ]
                        },
                        deepseek: {
                            name: 'DeepSeek',
                            models: [
                                { value: 'deepseek-chat', label: 'DeepSeek Chat' },
                                { value: 'deepseek-coder', label: 'DeepSeek Coder' }
                            ]
                        },
                        anthropic: {
                            name: 'Anthropic',
                            models: [
                                { value: 'claude-3-5-sonnet-20241022', label: 'Claude 3.5 Sonnet' },
                                { value: 'claude-3-5-haiku-20241022', label: 'Claude 3.5 Haiku' },
                                { value: 'claude-3-opus-20240229', label: 'Claude 3 Opus' }
                            ]
                        },
                        google: {
                            name: 'Google',
                            models: [
                                { value: 'gemini-1.5-pro', label: 'Gemini 1.5 Pro' },
                                { value: 'gemini-1.5-flash', label: 'Gemini 1.5 Flash' },
                                { value: 'gemini-1.0-pro', label: 'Gemini 1.0 Pro' }
                            ]
                        }
                    };
                    updateProviderOptions();
                    updateModelOptions($('#node-config-input-model'), node.provider);
                    updateModelOptions($('#node-config-input-planningModel'), node.provider);
                    updateModelOptions($('#node-config-input-executionModel'), node.provider);
                });
            }
            
            // 更新提供商选择器选项
            function updateProviderOptions() {
                const $providerSelect = $('#node-config-input-provider');
                $providerSelect.empty();
                
                Object.keys(providersData).forEach(function(providerId) {
                    const provider = providersData[providerId];
                    $providerSelect.append($('<option></option>')
                        .attr('value', providerId)
                        .text(provider.name)
                    );
                });
                
                // 设置当前选中的提供商
                if (node.provider && providersData[node.provider]) {
                    $providerSelect.val(node.provider);
                }
            }
            
            // 更新模型选项
            function updateModelOptions(selectElement, providerId) {
                const provider = providersData[providerId];
                if (!provider || !provider.models) {
                    selectElement.empty();
                    return;
                }
                
                selectElement.empty();
                provider.models.forEach(function(model) {
                    selectElement.append($('<option></option>')
                        .attr('value', model.value)
                        .text(model.label)
                    );
                });
                
                // 设置默认选中的模型
                if (provider.models.length > 0) {
                    // 如果当前节点有设置的模型，尝试选中它
                    const currentModel = selectElement.attr('id') === 'node-config-input-model' ? node.model :
                                       selectElement.attr('id') === 'node-config-input-planningModel' ? node.planningModel :
                                       node.executionModel;
                    
                    if (currentModel && provider.models.find(m => m.value === currentModel)) {
                        selectElement.val(currentModel);
                    } else {
                        selectElement.val(provider.models[0].value);
                    }
                }
            }
            
            // 提供商变化时更新模型选项
            $('#node-config-input-provider').change(function() {
                const provider = $(this).val();
                updateModelOptions($('#node-config-input-model'), provider);
                updateModelOptions($('#node-config-input-planningModel'), provider);
                updateModelOptions($('#node-config-input-executionModel'), provider);
            });
            
            // 切换不同模型配置
            $('#node-config-input-useDifferentModels').change(function() {
                if ($(this).is(':checked')) {
                    $('.different-models-config').show();
                } else {
                    $('.different-models-config').hide();
                }
            });
            
            // 初始化显示状态
            if (node.useDifferentModels) {
                $('.different-models-config').show();
            }
            
            // 加载提供商和模型数据
            loadProvidersAndModels();
            

            
            // API密钥输入验证 - 只允许数字、字母和常见符号
            $('#node-config-input-apiKey').on('input', function() {
                var value = $(this).val();
                // 只保留ASCII字符：数字、字母、常见符号
                var filteredValue = value.replace(/[^\x20-\x7E]/g, '');
                if (value !== filteredValue) {
                    $(this).val(filteredValue);
                    // 显示提示信息
                    if (!$('#apikey-warning').length) {
                        $(this).after('<div id="apikey-warning" style="color: orange; font-size: 12px; margin-top: 2px;"><i class="fa fa-warning"></i> <span data-i18n="api-config.validation.apiKeyFiltered"></span></div>');
                        setTimeout(function() {
                            $('#apikey-warning').fadeOut(function() {
                                $(this).remove();
                            });
                        }, 3000);
                    }
                }
            });
        }
    });
</script>

<!-- API配置节点的帮助信息 -->
<script type="text/x-red" data-help-name="api-config">
    <p>Configuration node for AI service providers including DeepSeek, OpenAI, and Anthropic APIs.</p>
    
    <h3>Details</h3>
    <p>This configuration node manages connections to various AI service providers. It handles authentication, model selection, and API parameters for seamless integration with AI services.</p>
    
    <h4>Providers</h4>
    <p>Supports multiple AI providers including DeepSeek, OpenAI, Anthropic, and other compatible services. Each provider offers different models and capabilities.</p>
    
    <h4>API Key</h4>
    <p>Securely store and manage API keys for different service providers. Keys are encrypted and stored securely in the Node-RED credentials system.</p>
    
    <h4>Model Selection</h4>
    <p>Configure specific AI models for each provider, including GPT-4, Claude, DeepSeek models, and custom endpoints. Model selection affects response quality and cost.</p>
    
    <h4>Advanced Options</h4>
    <p>Advanced options include custom endpoints, timeout settings, retry logic, and response formatting parameters.</p>
    
    <h3>Configuration</h3>
    <h4>Setup Steps</h4>
    <p>1. Select your AI service provider<br/>
    2. Enter your API key<br/>
    3. Choose the appropriate model<br/>
    4. Configure advanced settings if needed<br/>
    5. Test the connection</p>
    
    <h4>Validation</h4>
    <p>Configuration automatically validates API keys and tests connections to ensure proper setup.</p>
    
    <h4>Security</h4>
    <p>API keys are stored using Node-RED's secure credentials system and are never exposed in flows or logs.</p>
    
    <h3>References</h3>
    <ul>
        <li><a href="https://platform.deepseek.com/api-docs" target="_blank">DeepSeek API Documentation</a></li>
        <li><a href="https://platform.openai.com/docs/api-reference" target="_blank">OpenAI API Documentation</a></li>
        <li><a href="https://docs.anthropic.com/claude/reference" target="_blank">Anthropic API Documentation</a></li>
        <li><a href="https://github.com/your-repo/node-red-make-iot-smart/blob/main/TROUBLESHOOTING.md" target="_blank">Troubleshooting Guide</a></li>
    </ul>
</script>
